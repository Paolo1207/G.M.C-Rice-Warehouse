<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forecast - G.M.C. Rice Warehouse</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forecast.css') }}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-brand">
                <h1>G.M.C. Rice Warehouse</h1>
            </div>
            <div class="nav-main">
                <div class="nav-section">
                    <h2>Main Menu</h2>
                    <ul>
                        <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="{{ url_for('inventory') }}"><i class="fas fa-box"></i> Inventory</a></li>
                        <li><a href="{{ url_for('forecast') }}" class="active"><i class="fas fa-chart-line"></i> Forecast</a></li>
                        <li><a href="{{ url_for('sales') }}"><i class="fas fa-shopping-cart"></i> Sales</a></li>
                        <li><a href="{{ url_for('purchase') }}"><i class="fas fa-shopping-bag"></i> Purchase</a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <h2>Reports</h2>
                    <ul>
                        <li><a href="{{ url_for('reports') }}"><i class="fas fa-file-alt"></i> All Reports</a></li>
                        <li><a href="{{ url_for('analytics') }}" class="active"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <h2>Settings</h2>
                    <ul>
                        <li><a href="{{ url_for('notifications') }}"><i class="fas fa-bell"></i> Notifications</a></li>
                        <li><a href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> Account Settings</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="forecast-container">
                <div class="forecast-header">
                    <h2><i class="fas fa-chart-line"></i> Demand Forecasting</h2>
                    <div class="forecast-actions">
                        <button class="btn secondary" onclick="exportForecast()">
                            <i class="fas fa-download"></i> Export Report
                        </button>
                    </div>
                </div>

                <div class="forecast-tabs">
                    <button class="tab-btn active" data-tab="demand">
                        <i class="fas fa-chart-bar"></i> Demand Forecast
                    </button>
                    <button class="tab-btn" data-tab="price">
                        <i class="fas fa-tag"></i> Price Forecast
                    </button>
                    <button class="tab-btn" data-tab="risk">
                        <i class="fas fa-exclamation-triangle"></i> Stock Risk
                    </button>
                </div>

                <!-- Demand Forecast Tab -->
                <div class="tab-content active" id="demand-forecast">
                    <div class="forecast-filters">
                        <div class="filter-group">
                            <select id="productFilter">
                                <option value="">Select Product</option>
                                <option value="premium">Premium Rice</option>
                                <option value="regular">Regular Rice</option>
                                <option value="special">Special Varieties</option>
                            </select>
                            <select id="categoryFilter">
                                <option value="">Select Category</option>
                                <option value="all">All Categories</option>
                            </select>
                            <select id="regionFilter">
                                <option value="">Select Region</option>
                                <option value="all">All Regions</option>
                            </select>
                        </div>
                        <div class="date-range">
                            <select id="timeRange">
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Next Month</option>
                            </select>
                        </div>
                    </div>

                    <div class="forecast-grid">
                        <div class="forecast-chart">
                            <h3><i class="fas fa-chart-line"></i> Demand Forecast</h3>
                            <canvas id="demandChart"></canvas>
                        </div>
                        <div class="forecast-summary">
                            <h3><i class="fas fa-info-circle"></i> Forecast Summary</h3>
                            <div class="summary-cards">
                                <div class="summary-card">
                                    <h4>Average Demand</h4>
                                    <p class="number">1,234</p>
                                    <p class="trend positive">
                                        <i class="fas fa-arrow-up"></i>
                                        +5.2% from last period
                                    </p>
                                </div>
                                <div class="summary-card">
                                    <h4>Peak Day</h4>
                                    <p class="date">March 15, 2024</p>
                                    <p class="quantity">2,500 kg</p>
                                </div>
                                <div class="summary-card">
                                    <h4>Suggested Reorder</h4>
                                    <p class="number">500</p>
                                    <p class="trend">Based on forecast</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="forecast-table-container">
                        <h3><i class="fas fa-table"></i> Forecast Details</h3>
                        <table class="forecast-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Projected Quantity</th>
                                    <th>Confidence</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="forecastTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Price Forecast Tab -->
                <div class="tab-content" id="price-forecast">
                    <div class="forecast-filters">
                        <div class="filter-group">
                            <select id="priceProductFilter">
                                <option value="">Select Product</option>
                                <option value="premium">Premium Rice</option>
                                <option value="regular">Regular Rice</option>
                                <option value="special">Special Varieties</option>
                            </select>
                            <select id="priceTimeRange">
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 3 Months</option>
                                <option value="180">Last 6 Months</option>
                            </select>
                        </div>
                    </div>

                    <div class="forecast-grid">
                        <div class="forecast-chart">
                            <h3><i class="fas fa-chart-line"></i> Price Movement</h3>
                            <canvas id="priceChart"></canvas>
                        </div>
                        <div class="price-insights">
                            <h3><i class="fas fa-lightbulb"></i> Price Insights</h3>
                            <div class="insight-cards">
                                <div class="insight-card">
                                    <h4>Current Price</h4>
                                    <p class="price">â‚±99.99/kg</p>
                                    <p class="trend positive">
                                        <i class="fas fa-arrow-up"></i>
                                        +4% from last month
                                    </p>
                                </div>
                                <div class="insight-card">
                                    <h4>Predicted Change</h4>
                                    <p class="prediction">+4%</p>
                                    <p class="reason">Due to upcoming holiday</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Risk Tab -->
                <div class="tab-content" id="risk-forecast">
                    <div class="forecast-filters">
                        <div class="filter-group">
                            <select id="riskProductFilter">
                                <option value="">All Products</option>
                                <option value="premium">Premium Rice</option>
                                <option value="regular">Regular Rice</option>
                                <option value="special">Special Varieties</option>
                            </select>
                            <select id="riskCategoryFilter">
                                <option value="">All Categories</option>
                                <option value="shortage">Shortage</option>
                                <option value="overstock">Overstock</option>
                            </select>
                            <select id="riskSeverityFilter">
                                <option value="">All Severity Levels</option>
                                <option value="critical">Critical</option>
                                <option value="moderate">Moderate</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="date-range">
                            <select id="riskDateRange">
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 3 Months</option>
                            </select>
                        </div>
                    </div>

                    <div class="risk-overview">
                        <div class="risk-card critical">
                            <h4><i class="fas fa-exclamation-circle"></i> Critical Risk</h4>
                            <p class="number">5</p>
                            <p class="description">Items requiring immediate attention</p>
                        </div>
                        <div class="risk-card moderate">
                            <h4><i class="fas fa-exclamation-triangle"></i> Moderate Risk</h4>
                            <p class="number">12</p>
                            <p class="description">Items to monitor closely</p>
                        </div>
                        <div class="risk-card low">
                            <h4><i class="fas fa-check-circle"></i> Low Risk</h4>
                            <p class="number">45</p>
                            <p class="description">Items in good standing</p>
                        </div>
                    </div>

                    <div class="risk-table-container">
                        <div class="risk-table-header">
                            <h3><i class="fas fa-table"></i> Risk Analysis</h3>
                            <button class="btn secondary" onclick="exportRiskReport()">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                        <table class="risk-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Risk Type</th>
                                    <th>Severity Level</th>
                                    <th>Current Stock</th>
                                    <th>Threshold</th>
                                    <th>Suggested Action</th>
                                </tr>
                            </thead>
                            <tbody id="riskTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Initialize forecast page
        document.addEventListener('DOMContentLoaded', function() {
            initForecast();
        });

        function initForecast() {
            setupTabs();
            initCharts();
            loadForecastData();
            // Ensure risk data is loaded initially if risk tab is active
            if (document.querySelector('.tab-btn[data-tab="risk"].active')) {
                loadRiskData();
            }
        }

        // Setup tab switching
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    
                    // Update active states
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const targetContent = document.getElementById(`${tabId}-forecast`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }

                    // If switching to risk tab, ensure data is loaded
                    if (tabId === 'risk') {
                        loadRiskData();
                    }
                });
            });
        }

        // Initialize charts
        function initCharts() {
            // Demand Chart
            const demandCtx = document.getElementById('demandChart').getContext('2d');
            new Chart(demandCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Actual Demand',
                        data: [65, 59, 80, 81, 56, 55],
                        borderColor: '#1a365d',
                        backgroundColor: 'rgba(26, 54, 93, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Forecasted Demand',
                        data: [null, null, null, 81, 56, 55, 60, 65],
                        borderColor: '#ecc94b',
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Demand Forecast',
                            font: {
                                family: 'Inter',
                                size: 16,
                                weight: '600'
                            },
                            color: '#1a365d'
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });

            // Price Chart
            const priceCtx = document.getElementById('priceChart').getContext('2d');
            new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Price per Unit',
                        data: [90, 92, 95, 93, 96, 99],
                        borderColor: '#1a365d',
                        backgroundColor: 'rgba(26, 54, 93, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Price Movement',
                            font: {
                                family: 'Inter',
                                size: 16,
                                weight: '600'
                            },
                            color: '#1a365d'
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Load forecast data
        async function loadForecastData() {
            // Simulated data - replace with actual API call
            const data = {
                demand: [
                    {
                        date: '2024-03-15',
                        projected: 1500,
                        confidence: '85%',
                        trend: 'Increasing'
                    },
                    {
                        date: '2024-03-16',
                        projected: 1600,
                        confidence: '82%',
                        trend: 'Increasing'
                    },
                    {
                        date: '2024-03-17',
                        projected: 1550,
                        confidence: '80%',
                        trend: 'Stable'
                    }
                ],
                risk: [
                    {
                        product: 'Premium Jasmine Rice',
                        riskType: 'Shortage',
                        severity: 'critical',
                        currentStock: 50,
                        threshold: 200,
                        suggestedAction: 'Immediate restock required'
                    },
                    {
                        product: 'Regular White Rice',
                        riskType: 'Overstock',
                        severity: 'moderate',
                        currentStock: 1500,
                        threshold: 1000,
                        suggestedAction: 'Consider promotional pricing'
                    },
                    {
                        product: 'Special Basmati Rice',
                        riskType: 'Shortage',
                        severity: 'low',
                        currentStock: 180,
                        threshold: 150,
                        suggestedAction: 'Monitor stock levels'
                    },
                    {
                        product: 'Premium Brown Rice',
                        riskType: 'Shortage',
                        severity: 'critical',
                        currentStock: 30,
                        threshold: 150,
                        suggestedAction: 'Urgent restock needed'
                    },
                    {
                        product: 'Regular Brown Rice',
                        riskType: 'Overstock',
                        severity: 'moderate',
                        currentStock: 800,
                        threshold: 500,
                        suggestedAction: 'Review pricing strategy'
                    }
                ]
            };

            renderForecastTable(data.demand);
            renderRiskTable(data.risk);
        }

        // Render forecast table
        function renderForecastTable(data) {
            const tbody = document.getElementById('forecastTableBody');
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${item.projected} kg</td>
                    <td>${item.confidence}</td>
                    <td>${item.trend}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load risk data
        function loadRiskData() {
            const riskData = [
                {
                    product: 'Premium Jasmine Rice',
                    riskType: 'Shortage',
                    severity: 'critical',
                    currentStock: 50,
                    threshold: 200,
                    suggestedAction: 'Immediate restock required'
                },
                {
                    product: 'Regular White Rice',
                    riskType: 'Overstock',
                    severity: 'moderate',
                    currentStock: 1500,
                    threshold: 1000,
                    suggestedAction: 'Consider promotional pricing'
                },
                {
                    product: 'Special Basmati Rice',
                    riskType: 'Shortage',
                    severity: 'low',
                    currentStock: 180,
                    threshold: 150,
                    suggestedAction: 'Monitor stock levels'
                },
                {
                    product: 'Premium Brown Rice',
                    riskType: 'Shortage',
                    severity: 'critical',
                    currentStock: 30,
                    threshold: 150,
                    suggestedAction: 'Urgent restock needed'
                },
                {
                    product: 'Regular Brown Rice',
                    riskType: 'Overstock',
                    severity: 'moderate',
                    currentStock: 800,
                    threshold: 500,
                    suggestedAction: 'Review pricing strategy'
                }
            ];

            // Update risk overview cards
            updateRiskOverview(riskData);
            // Render risk table
            renderRiskTable(riskData);
        }

        // Update risk overview cards
        function updateRiskOverview(data) {
            const criticalCard = document.querySelector('.risk-card.critical .number');
            const moderateCard = document.querySelector('.risk-card.moderate .number');
            const lowCard = document.querySelector('.risk-card.low .number');
            if (!criticalCard || !moderateCard || !lowCard) return; // Prevent error if not rendered yet

            const criticalCount = data.filter(item => item.severity === 'critical').length;
            const moderateCount = data.filter(item => item.severity === 'moderate').length;
            const lowCount = data.filter(item => item.severity === 'low').length;

            criticalCard.textContent = criticalCount;
            moderateCard.textContent = moderateCount;
            lowCard.textContent = lowCount;
        }

        // Render risk table
        function renderRiskTable(data) {
            const tbody = document.getElementById('riskTableBody');
            if (!tbody) return; // Guard clause in case element doesn't exist

            tbody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.product}</td>
                    <td>
                        <span class="risk-type ${item.riskType.toLowerCase()}">
                            ${item.riskType}
                        </span>
                    </td>
                    <td>
                        <span class="risk-badge ${item.severity}">
                            ${item.severity.charAt(0).toUpperCase() + item.severity.slice(1)}
                        </span>
                    </td>
                    <td>${item.currentStock} kg</td>
                    <td>${item.threshold} kg</td>
                    <td>${item.suggestedAction}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Format date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Export forecast
        function exportForecast() {
            showToast('Forecast exported successfully', 'success');
        }

        // Export risk report
        function exportRiskReport() {
            showToast('Risk report exported successfully', 'success');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                              type === 'error' ? 'fa-exclamation-circle' : 
                              'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Setup event listeners for risk filters
        function setupRiskFilters() {
            const productFilter = document.getElementById('riskProductFilter');
            const categoryFilter = document.getElementById('riskCategoryFilter');
            const severityFilter = document.getElementById('riskSeverityFilter');
            const dateRangeFilter = document.getElementById('riskDateRange');

            if (productFilter) productFilter.addEventListener('change', filterRiskData);
            if (categoryFilter) categoryFilter.addEventListener('change', filterRiskData);
            if (severityFilter) severityFilter.addEventListener('change', filterRiskData);
            if (dateRangeFilter) dateRangeFilter.addEventListener('change', filterRiskData);
        }

        // Filter risk data
        function filterRiskData() {
            showToast('Filtering risk data...', 'info');
            // Implement filtering logic here
        }
    </script>
</body>
</html>