<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="pageTitle">Analytics - G.M.C. Rice Warehouse</title>

  <!-- Manager static assets -->
  <link rel="stylesheet" href="{{ url_for('manager.static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('manager.static', filename='css/analytics.css') }}">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-brand">
        <h1 id="branchTitle">G.M.C. Rice Warehouse</h1>
      </div>
      <div class="nav-main">
        <div class="nav-section">
          <h2>Main Menu</h2>
          <ul>
            <li><a href="{{ url_for('manager.manager_dashboard') }}"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="{{ url_for('manager.inventory') }}"><i class="fas fa-box"></i> Inventory</a></li>
            <li><a href="{{ url_for('manager.forecast') }}"><i class="fas fa-chart-line"></i> Forecast</a></li>
            <li><a href="{{ url_for('manager.sales') }}"><i class="fas fa-shopping-cart"></i> Sales</a></li>
            <li><a href="{{ url_for('manager.purchase') }}"><i class="fas fa-shopping-bag"></i> Purchase</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h2>Reports</h2>
          <ul>
            <li><a href="{{ url_for('manager.reports') }}"><i class="fas fa-file-alt"></i> All Reports</a></li>
            <li><a href="{{ url_for('manager.analytics') }}" class="active"><i class="fas fa-chart-bar"></i> Analytics</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h2>Settings</h2>
          <ul>
            <li><a href="{{ url_for('manager.notifications') }}"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="{{ url_for('manager.settings') }}"><i class="fas fa-cog"></i> Account Settings</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="analytics-container">
        <div class="analytics-header">
          <h2>Analytics</h2>
          <div class="analytics-actions">
            <button class="btn primary" id="print-analytics-btn">
              <i class="fas fa-print"></i> Print
            </button>
          </div>
        </div>
        
        <!-- Analytics Description -->
        <div class="analytics-description" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #1a365d;">
          <h3 style="margin: 0 0 0.5rem 0; color: #1a365d; font-size: 1.1rem;">
            <i class="fas fa-info-circle"></i> About Analytics
          </h3>
          <p style="margin: 0; color: #374151; line-height: 1.6;">
            This analytics dashboard provides insights into your branch's performance, including forecast accuracy, inventory trends, sales patterns, and risk analysis. 
            Data is updated in real-time based on your branch's transactions and inventory. Use these insights to make informed decisions about stock management, purchasing, and sales strategies.
          </p>
        </div>

        <!-- Forecast Accuracy -->
        <div class="analytics-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>Forecast Accuracy</h3>
          </div>
          <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">
            <i class="fas fa-lightbulb"></i> Compares predicted demand (from forecasts) with actual sales to measure how accurate your demand predictions are. 
            Higher accuracy means your forecasts are reliable for inventory planning.
          </p>
          <div class="accuracy-overview">
            <div class="accuracy-card">
              <div class="accuracy-icon"><i class="fas fa-bullseye"></i></div>
              <div class="accuracy-info">
                <h4>Overall Accuracy</h4>
                <p class="accuracy-value" id="overallAccuracyValue">--</p>
                <p class="accuracy-period" id="accuracyPeriod">Loading...</p>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="forecastAccuracyChart"></canvas>
            </div>
          </div>

          <div class="product-accuracy">
            <h4>Accuracy by Product</h4>
            <div class="table-container">
              <table class="accuracy-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Forecasted</th>
                    <th>Actual</th>
                    <th>Accuracy</th>
                    <th>Trend</th>
                  </tr>
                </thead>
                <tbody id="productAccuracyBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Inventory Trends -->
        <div class="analytics-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>Inventory Trends</h3>
          </div>
          <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">
            <i class="fas fa-lightbulb"></i> Tracks daily stock movements (restocks and sales) and shows how inventory is distributed across product categories. 
            Helps identify which categories need more attention and when stock levels change.
          </p>
          <div class="trends-grid">
            <div class="chart-container">
              <h4>Stock Movement</h4>
              <canvas id="stockMovementChart"></canvas>
            </div>
            <div class="chart-container">
              <h4>Category Stock Levels</h4>
              <canvas id="categoryStockChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Sales Trends -->
        <div class="analytics-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>Sales Trends</h3>
          </div>
          <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">
            <i class="fas fa-lightbulb"></i> Shows your best-selling products and weekly sales performance. 
            Use this to identify popular items and understand sales patterns over time.
          </p>
          <div class="trends-grid">
            <div class="chart-container">
              <h4>Top 5 Bestselling Items</h4>
              <canvas id="topProductsChart"></canvas>
            </div>
            <div class="chart-container">
              <h4>Weekly Sales Performance</h4>
              <canvas id="weeklySalesChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Risk Visualization -->
        <div class="analytics-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>Risk Visualization</h3>
          </div>
          <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">
            <i class="fas fa-lightbulb"></i> Identifies products at risk of stockout (shortage) or overstock situations. 
            High-risk items require immediate attention to prevent lost sales or excess inventory costs.
          </p>
          <div class="risk-grid">
            <div class="chart-container">
              <h4>Product Risk Heatmap</h4>
              <canvas id="riskHeatmap"></canvas>
            </div>
            <div class="risk-table-container">
              <h4>High-Risk Products</h4>
              <div class="table-container">
                <table class="risk-table">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Risk Level</th>
                      <th>Forecasted Shortage/Overstock</th>
                      <th>Suggested Action</th>
                    </tr>
                  </thead>
                  <tbody id="riskTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Manager JS -->
  <script src="{{ url_for('manager.static', filename='js/main.js') }}"></script>

  <script>
    // Store chart instances for updating
    let chartInstances = {
      forecastAccuracy: null,
      stockMovement: null,
      categoryStock: null,
      topProducts: null,
      weeklySales: null,
      riskHeatmap: null
    };

    let refreshInterval = null;

    document.addEventListener('DOMContentLoaded', function () { 
      initAnalytics();
      // Set up auto-refresh every 30 seconds
      refreshInterval = setInterval(() => {
        refreshAnalytics();
      }, 30000);
      // Listen for data update events
      document.addEventListener('inventoryDataUpdated', refreshAnalytics);
      document.addEventListener('salesDataUpdated', refreshAnalytics);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
      if (refreshInterval) clearInterval(refreshInterval);
      // Destroy all charts
      Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
      });
    });

    async function initAnalytics() {
      updateBranchTitle();
      const { branchId, branchName } = getBranchParams();
      if (!branchId) {
        console.error('No branch ID found in URL parameters');
        showError('Branch ID is missing. Please access this page from the dashboard or login with a branch selected.');
        // Try to get branch from manager session
        try {
          const whoami = await fetch('/whoami');
          const userData = await whoami.json();
          if (userData.ok && userData.user && userData.user.branch_id) {
            const detectedBranchId = userData.user.branch_id;
            console.log(`Detected branch ID from session: ${detectedBranchId}`);
            await loadAnalyticsData(detectedBranchId);
          }
        } catch (e) {
          console.error('Could not detect branch from session:', e);
        }
        return;
      }
      console.log(`Initializing analytics for branch: ${branchId} (${branchName || 'Unknown'})`);
      await loadAnalyticsData(branchId);
    }

    async function refreshAnalytics() {
      const { branchId } = getBranchParams();
      if (!branchId) return;
      await loadAnalyticsData(branchId);
    }

    async function loadAnalyticsData(branchId) {
      try {
        if (!branchId) {
          showError('Branch ID is required. Please select a branch.');
          return;
        }
        
        // Show loading state
        document.getElementById('overallAccuracyValue').textContent = 'Loading...';
        document.getElementById('accuracyPeriod').textContent = 'Fetching data...';
        
        const data = await fetchBranchAnalytics(branchId);
        if (!data || !data.ok) {
          const errorMsg = data?.error || 'Failed to fetch analytics data';
          console.error('Failed to fetch analytics:', errorMsg);
          showError(errorMsg);
          return;
        }
        const a = data.analytics || {};
        console.log(`Analytics data loaded for branch ${branchId}:`, {
          forecast_count: a.forecast_vs_actual_7d?.length || 0,
          product_accuracy_count: a.product_accuracy?.length || 0,
          top_products_count: a.top_products_month?.length || 0,
          risks_count: a.branch_risks?.length || 0
        });
        renderForecastAccuracy(a);
        renderInventoryTrends(a);
        renderSalesTrends(a);
        renderRiskVisualization(a);
      } catch (error) {
        console.error('Error loading analytics:', error);
        showError('An error occurred while loading analytics data. Please try again.');
      }
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.style.cssText = 'background: #ffebee; color: #c62828; padding: 15px; margin: 20px; border-radius: 5px; border-left: 4px solid #c62828;';
      errorDiv.textContent = message;
      const container = document.querySelector('.analytics-container');
      const existingError = container.querySelector('.error-message');
      if (existingError) existingError.remove();
      container.insertBefore(errorDiv, container.firstChild);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    // Fetch analytics for branch
    async function fetchBranchAnalytics(branchId) {
      try {
        if (!branchId) {
          console.error('No branch ID provided');
          return null;
        }
        const resp = await fetch(`/manager/api/analytics?branch_id=${branchId}`);
        if (!resp.ok) {
          console.error(`Failed to fetch analytics: ${resp.status} ${resp.statusText}`);
          return null;
        }
        const data = await resp.json();
        if (!data.ok) {
          console.error('Analytics API returned error:', data.error);
          return null;
        }
        console.log(`Analytics loaded for branch ${branchId}:`, data.analytics);
        return data;
      } catch (e) {
        console.error('Failed to fetch manager analytics', e);
        return null;
      }
    }

    function getBranchParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const branchId = urlParams.get('branch') || urlParams.get('branch_id');
      const branchName = urlParams.get('branch_name');
      return { branchId, branchName };
    }

    // Forecast Accuracy
    function renderForecastAccuracy(analytics) {
      // Update overall accuracy and period
      const overallAccuracy = analytics.overall_accuracy || 0;
      const accuracyPeriod = analytics.accuracy_period || 'Loading...';
      document.getElementById('overallAccuracyValue').textContent = `${overallAccuracy.toFixed(1)}%`;
      document.getElementById('accuracyPeriod').textContent = accuracyPeriod;

      const fva = analytics.forecast_vs_actual_7d || [];
      const labels = fva.map(x => x.date);
      const forecast = fva.map(x => x.forecast || 0);
      const actual = fva.map(x => x.actual || 0);
      
      // Destroy existing chart if it exists
      if (chartInstances.forecastAccuracy) {
        chartInstances.forecastAccuracy.destroy();
      }
      
      const ctx = document.getElementById('forecastAccuracyChart').getContext('2d');
      chartInstances.forecastAccuracy = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [
          { label: 'Forecasted', data: forecast, borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: false },
          { label: 'Actual',     data: actual,   borderColor: 'rgb(255, 99, 132)', tension: 0.1, fill: false }
        ]},
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: { 
            title: { display: true, text: 'Forecast vs Actual Sales (Qty)' },
            legend: { display: true, position: 'top' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      const products = analytics.product_accuracy || [];
      const tbody = document.getElementById('productAccuracyBody');
      tbody.innerHTML = '';
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #64748b;"><i class="fas fa-info-circle"></i> No product accuracy data available. Generate forecasts and record sales to see accuracy metrics.</td></tr>';
      } else {
        products.forEach(item => {
          const forecasted = item.forecasted || 0;
          const actual = item.actual || 0;
          const accuracy = item.accuracy || 0;
          
          // Calculate trend: up if actual > forecasted, down if actual < forecasted
          const trend = actual > forecasted ? 'up' : actual < forecasted ? 'down' : 'minus';
          const trendClass = trend === 'up' ? 'positive' : trend === 'down' ? 'negative' : '';
          const trendIcon = trend === 'up' ? 'fa-arrow-up' : trend === 'down' ? 'fa-arrow-down' : 'fa-minus';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.name || ('Product ' + item.product_id)}</td>
            <td>${forecasted.toLocaleString()}</td>
            <td>${actual.toLocaleString()}</td>
            <td>${accuracy.toFixed(1)}%</td>
            <td><i class="fas ${trendIcon} ${trendClass}"></i></td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    // Inventory Trends
    function renderInventoryTrends(analytics) {
      const sm = analytics.stock_movement_7d || { labels: [], stock_in: [], stock_out: [] };
      
      // Destroy existing chart if it exists
      if (chartInstances.stockMovement) {
        chartInstances.stockMovement.destroy();
      }
      
      const stockMovementCtx = document.getElementById('stockMovementChart').getContext('2d');
      chartInstances.stockMovement = new Chart(stockMovementCtx, {
        type: 'bar',
        data: {
          labels: sm.labels,
          datasets: [
            { label: 'Stock In (kg)',  data: sm.stock_in, backgroundColor: 'rgba(75,192,192,0.2)', borderColor: 'rgb(75,192,192)', borderWidth: 1 },
            { label: 'Stock Out (kg)', data: sm.stock_out, backgroundColor: 'rgba(255,99,132,0.2)', borderColor: 'rgb(255,99,132)', borderWidth: 1 }
          ]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: { title: { display: true, text: 'Daily Stock Movement (kg)' } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const cats = analytics.category_levels || [];
      
      // Destroy existing chart if it exists
      if (chartInstances.categoryStock) {
        chartInstances.categoryStock.destroy();
      }
      
      const categoryStockCtx = document.getElementById('categoryStockChart').getContext('2d');
      chartInstances.categoryStock = new Chart(categoryStockCtx, {
        type: 'doughnut',
        data: {
          labels: cats.map(c => c.category || 'Uncategorized'),
          datasets: [{ 
            data: cats.map(c => c.stock_kg || 0), 
            backgroundColor: ['rgb(75,192,192)','rgb(255,99,132)','rgb(255,205,86)','rgb(54,162,235)','rgb(153,102,255)','rgb(255,159,64)','rgb(201,203,207)'] 
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: { title: { display: true, text: 'Stock Distribution by Category (kg)' } }
        }
      });
    }

    // Sales Trends
    function renderSalesTrends(analytics) {
      const tops = analytics.top_products_month || [];
      
      // Destroy existing chart if it exists
      if (chartInstances.topProducts) {
        chartInstances.topProducts.destroy();
      }
      
      const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
      chartInstances.topProducts = new Chart(topProductsCtx, {
        type: 'pie',
        data: {
          labels: tops.length > 0 ? tops.map(t => t.name || 'Unknown') : ['No Data'],
          datasets: [{ 
            data: tops.length > 0 ? tops.map(t => t.quantity || 0) : [1], 
            backgroundColor: ['rgb(75,192,192)','rgb(255,99,132)','rgb(255,205,86)','rgb(54,162,235)','rgb(153,102,255)','rgb(255,159,64)','rgb(201,203,207)'] 
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: { title: { display: true, text: 'Top 5 Bestselling Items (Qty)' } }
        }
      });

      const weekly = analytics.weekly_sales_4w || { labels: [], sales: [] };
      
      // Destroy existing chart if it exists
      if (chartInstances.weeklySales) {
        chartInstances.weeklySales.destroy();
      }
      
      const weeklySalesCtx = document.getElementById('weeklySalesChart').getContext('2d');
      chartInstances.weeklySales = new Chart(weeklySalesCtx, {
        type: 'bar',
        data: { 
          labels: weekly.labels.length > 0 ? weekly.labels : ['Week 1', 'Week 2', 'Week 3', 'Week 4'], 
          datasets: [{ 
            label: 'Sales (‚Ç±)', 
            data: weekly.sales.length > 0 ? weekly.sales : [0, 0, 0, 0], 
            backgroundColor: 'rgba(75,192,192,0.2)', 
            borderColor: 'rgb(75,192,192)', 
            borderWidth: 1 
          }] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: { title: { display: true, text: 'Weekly Sales Performance (‚Ç±)' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Risk Visualization
    function renderRiskVisualization(analytics) {
      const risks = analytics.branch_risks || [];
      
      // Destroy existing chart if it exists
      if (chartInstances.riskHeatmap) {
        chartInstances.riskHeatmap.destroy();
      }
      
      const riskHeatmapCtx = document.getElementById('riskHeatmap').getContext('2d');
      chartInstances.riskHeatmap = new Chart(riskHeatmapCtx, {
        type: 'bar',
        data: {
          labels: risks.length > 0 ? risks.map(r => r.product_name || ('Product ' + r.product_id)) : ['No Risks'],
          datasets: [{ 
            label: 'Risk Score', 
            data: risks.length > 0 ? risks.map(r => r.risk_score || 0) : [0], 
            backgroundColor: risks.map(r => {
              const score = r.risk_score || 0;
              if (score >= 70) return 'rgb(255,99,132)'; // High risk - red
              if (score >= 40) return 'rgb(255,159,64)'; // Medium risk - orange
              return 'rgb(255,205,86)'; // Low risk - yellow
            })
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: { title: { display: true, text: 'Product Risk Levels' } },
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });

      const tbody = document.getElementById('riskTableBody');
      tbody.innerHTML = '';
      if (risks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #64748b;"><i class="fas fa-check-circle" style="color: #10b981;"></i> No risk items found. Your inventory levels are balanced.</td></tr>';
      } else {
        risks.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.product_name || ('Product ' + item.product_id)}</td>
            <td><span class="risk-level ${item.risk_level.toLowerCase()}">${item.risk_level}</span></td>
            <td>${item.gap_kg > 0 ? 'Shortage: ' : item.gap_kg < 0 ? 'Overstock: ' : 'Balanced: '}${Math.abs(Number(item.gap_kg || 0)).toLocaleString()} kg</td>
            <td>${item.action || 'Monitor'}</td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    function printAnalyticsPage() {
      const printWindow = window.open('', '_blank', 'width=1200,height=800');
      if (!printWindow) {
        alert('Please allow popups to use the print feature');
        return;
      }

      const generatedAt = new Date().toLocaleString();
      const { branchName } = getBranchParams();
      const branchDisplayName = branchName ? decodeURIComponent(branchName) : 'Your Branch';

      // Get chart images
      let chartsHTML = '';
      const chartIds = ['forecastAccuracyChart', 'stockMovementChart', 'categoryStockChart', 'topProductsChart', 'weeklySalesChart', 'riskHeatmap'];
      const chartTitles = ['Forecast vs Actual Sales', 'Stock Movement', 'Category Stock Levels', 'Top 5 Bestselling Items', 'Weekly Sales Performance', 'Product Risk Heatmap'];
      
      chartIds.forEach((chartId, index) => {
        const chart = chartInstances[chartId.replace('Chart', '')] || 
                     (chartId === 'forecastAccuracyChart' ? chartInstances.forecastAccuracy :
                      chartId === 'stockMovementChart' ? chartInstances.stockMovement :
                      chartId === 'categoryStockChart' ? chartInstances.categoryStock :
                      chartId === 'topProductsChart' ? chartInstances.topProducts :
                      chartId === 'weeklySalesChart' ? chartInstances.weeklySales :
                      chartId === 'riskHeatmap' ? chartInstances.riskHeatmap : null);
        
        if (chart) {
          const chartImg = chart.toBase64Image();
          chartsHTML += `
            <div class="section">
              <h3>${chartTitles[index]}</h3>
              <img src="${chartImg}" class="chart-img" alt="${chartTitles[index]}">
            </div>
          `;
        }
      });

      // Get overall accuracy
      const overallAccuracy = document.getElementById('overallAccuracyValue')?.textContent || '--';
      const accuracyPeriod = document.getElementById('accuracyPeriod')?.textContent || '--';

      // Get product accuracy table
      const productAccuracyTable = document.getElementById('productAccuracyBody')?.innerHTML || '<tr><td colspan="5">No data available</td></tr>';

      // Get risk table
      const riskTable = document.getElementById('riskTableBody')?.innerHTML || '<tr><td colspan="4">No risk items found</td></tr>';

      const printHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Analytics Report - Print</title>
    <style>
        @media print {
            @page { margin: 1cm; size: landscape; }
            .no-print { display: none !important; }
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #1f2937;
        }
        .header {
            border-bottom: 3px solid #1a365d;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            color: #1a365d;
            font-size: 24px;
        }
        .header p {
            margin: 4px 0;
            color: #64748b;
            font-size: 12px;
        }
        .section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        .section h3 {
            color: #1a365d;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .chart-img {
            width: 100%;
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        table th, table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #e5e7eb;
        }
        table th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .kpi-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            background: #1a365d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Analytics Report - ${branchDisplayName}</h1>
        <p>Generated: ${generatedAt}</p>
    </div>

    <div class="section">
        <h3>üìä Overall Forecast Accuracy</h3>
        <div class="kpi-box">
            <strong>Overall Accuracy:</strong> ${overallAccuracy}<br>
            <strong>Period:</strong> ${accuracyPeriod}
        </div>
    </div>

    ${chartsHTML}

    <div class="section">
        <h3>üìã Accuracy by Product</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Forecasted</th>
                    <th>Actual</th>
                    <th>Accuracy</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody>
                ${productAccuracyTable}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>‚ö†Ô∏è High-Risk Products</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Risk Level</th>
                    <th>Forecasted Shortage/Overstock</th>
                    <th>Suggested Action</th>
                </tr>
            </thead>
            <tbody>
                ${riskTable}
            </tbody>
        </table>
    </div>

    <div class="actions no-print">
        <button class="btn" onclick="window.print()">Print</button>
    </div>
</body>
</html>`;

      printWindow.document.write(printHTML);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => { printWindow.print(); }, 500);
    }

    // Update title and header based on branch selection
    function updateBranchTitle() {
      const { branchName, branchId } = getBranchParams();
      if (branchName) {
        const decodedBranchName = decodeURIComponent(branchName);
        document.getElementById('pageTitle').textContent = `Analytics - G.M.C. Rice Warehouse - ${decodedBranchName} Branch`;
        document.getElementById('branchTitle').textContent = `G.M.C. Rice Warehouse - ${decodedBranchName} Branch`;
        updateNavigationLinks(branchId, branchName);
      }
    }

    // Update navigation links to include branch parameters
    function updateNavigationLinks(branchId, branchName) {
      const navLinks = document.querySelectorAll('.nav-main a[href]');
      navLinks.forEach(link => {
        const currentHref = link.getAttribute('href');
        if (currentHref && !currentHref.includes('branch=')) {
          const separator = currentHref.includes('?') ? '&' : '?';
          link.href = `${currentHref}${separator}branch=${branchId}&branch_name=${encodeURIComponent(branchName)}`;
        }
      });
    }

    // Call the function when page loads
    document.addEventListener('DOMContentLoaded', updateBranchTitle);
  </script>
</body>
</html>
