<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="pageTitle">Notifications - G.M.C. Rice Warehouse</title>

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('manager.static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('manager.static', filename='css/notifications.css') }}">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-brand">
        <h1 id="branchTitle">G.M.C. Rice Warehouse</h1>
      </div>

      <div class="nav-main">
        <div class="nav-section">
          <h2>Main Menu</h2>
          <ul>
            <li><a href="{{ url_for('manager.manager_dashboard') }}"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="{{ url_for('manager.inventory') }}"><i class="fas fa-box"></i> Inventory</a></li>
            <li><a href="{{ url_for('manager.forecast') }}"><i class="fas fa-chart-line"></i> Forecast</a></li>
            <li><a href="{{ url_for('manager.sales') }}"><i class="fas fa-shopping-cart"></i> Sales</a></li>
            <li><a href="{{ url_for('manager.purchase') }}"><i class="fas fa-shopping-bag"></i> Purchase</a></li>
          </ul>
        </div>

        <div class="nav-section">
          <h2>Reports</h2>
          <ul>
            <li><a href="{{ url_for('manager.reports') }}"><i class="fas fa-file-alt"></i> All Reports</a></li>
            <li><a href="{{ url_for('manager.analytics') }}"><i class="fas fa-chart-bar"></i> Analytics</a></li>
          </ul>
        </div>

        <div class="nav-section">
          <h2>Settings</h2>
          <ul>
            <li><a class="active" href="{{ url_for('manager.notifications') }}" class="active"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="{{ url_for('manager.settings') }}"><i class="fas fa-cog"></i> Account Settings</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="notifications-container">
        <div class="notifications-header">
          <h2>Notifications Center</h2>
          <div class="notifications-actions">
            <button class="btn secondary" type="button" onclick="markAllAsRead()">
              <i class="fas fa-check-double"></i> Mark All as Read
            </button>
            <button class="btn secondary" type="button" onclick="clearAllNotifications()">
              <i class="fas fa-trash"></i> Clear All
            </button>
          </div>
        </div>

        <!-- Filters -->
        <div class="notification-filters">
          <div class="filter-group">
            <label for="typeFilter">Type:</label>
            <select id="typeFilter" onchange="filterNotifications()">
              <option value="all">All Types</option>
              <option value="alert">Alerts</option>
              <option value="update">Updates</option>
              <option value="info">Information</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter" onchange="filterNotifications()">
              <option value="all">All Status</option>
              <option value="unread">Unread</option>
              <option value="read">Read</option>
            </select>
          </div>
        </div>

        <!-- System Alerts -->
        <div class="notification-section">
          <h3>System Alerts</h3>
          <div class="notification-list" id="systemAlerts">
            <div class="notification-item unread alert" onclick="toggleNotification(this)">
              <div class="notification-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="notification-content">
                <h4>Low Stock Alert</h4>
                <p>Premium Rice (25kg) is running low on stock. Current quantity: 5 units. Please reorder soon.</p>
                <span class="notification-time">2 hours ago</span>
              </div>
              <div class="notification-actions">
                <button class="btn-icon" onclick="markAsRead(event,this)" title="Mark as Read">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-icon" onclick="archiveNotification(event,this)" title="Archive">
                  <i class="fas fa-archive"></i>
                </button>
              </div>
            </div>

            <div class="notification-item update" onclick="toggleNotification(this)">
              <div class="notification-icon">
                <i class="fas fa-sync"></i>
              </div>
              <div class="notification-content">
                <h4>Inventory Update</h4>
                <p>New stock of Jasmine Rice (50kg) has been added. Quantity: 100 units.</p>
                <span class="notification-time">5 hours ago</span>
              </div>
              <div class="notification-actions">
                <button class="btn-icon" onclick="markAsRead(event,this)" title="Mark as Read">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-icon" onclick="archiveNotification(event,this)" title="Archive">
                  <i class="fas fa-archive"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Branch Announcements -->
        <div class="notification-section">
          <h3>Branch Announcements</h3>
          <div class="notification-list" id="branchAnnouncements">
            <div class="notification-item unread info" onclick="toggleNotification(this)">
              <div class="notification-icon">
                <i class="fas fa-bullhorn"></i>
              </div>
              <div class="notification-content">
                <h4>New Branch Opening</h4>
                <p>Weâ€™re opening a new branch in Makati next month. Join the grand opening!</p>
                <span class="notification-time">1 day ago</span>
              </div>
              <div class="notification-actions">
                <button class="btn-icon" onclick="markAsRead(event,this)" title="Mark as Read">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-icon" onclick="archiveNotification(event,this)" title="Archive">
                  <i class="fas fa-archive"></i>
                </button>
              </div>
            </div>

            <div class="notification-item alert" onclick="toggleNotification(this)">
              <div class="notification-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="notification-content">
                <h4>Monthly Inventory Count</h4>
                <p>Inventory count is scheduled for next week. Please prepare stock records & labels.</p>
                <span class="notification-time">2 days ago</span>
              </div>
              <div class="notification-actions">
                <button class="btn-icon" onclick="markAsRead(event,this)" title="Mark as Read">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-icon" onclick="archiveNotification(event,this)" title="Archive">
                  <i class="fas fa-archive"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
  <link rel="stylesheet" href="{{ url_for('manager.static', filename='css/notification-popup.css') }}">
  <script src="{{ url_for('manager.static', filename='js/notification-popup.js') }}" defer></script>
  <script defer>
    // Manager branch scoping
    let MANAGER_BRANCH_ID = null;
    let MANAGER_BRANCH_NAME = null;
    let notificationCheckInterval = null;

    document.addEventListener('DOMContentLoaded', initNotifications);

    async function initNotifications() {
      // Get manager's branch from URL or session
      const urlParams = new URLSearchParams(window.location.search);
      MANAGER_BRANCH_ID = urlParams.get('branch') || null;
      MANAGER_BRANCH_NAME = urlParams.get('branch_name') || null;
      
      // If no branch in URL, get from manager API
      if (!MANAGER_BRANCH_ID) {
        await loadManagerBranch();
      }
      
      // Update branch title immediately if we have branch info
      if (MANAGER_BRANCH_NAME) {
        updateBranchTitle();
      }
      
      // Load notifications from API
      await loadNotifications();
      
      // Start checking for new notifications every 30 seconds
      startNotificationPolling();
    }

    async function loadManagerBranch() {
      try {
        const response = await fetch('/manager/api/branches');
        const data = await response.json();
        if (data.ok && data.branches && data.branches.length > 0) {
          MANAGER_BRANCH_ID = data.branches[0].id;
          MANAGER_BRANCH_NAME = data.branches[0].name;
          
          // Update the URL to include branch parameters if they're missing
          const urlParams = new URLSearchParams(window.location.search);
          if (!urlParams.get('branch') || !urlParams.get('branch_name')) {
            const newUrl = `${window.location.pathname}?branch=${MANAGER_BRANCH_ID}&branch_name=${encodeURIComponent(MANAGER_BRANCH_NAME)}`;
            window.history.replaceState({}, '', newUrl);
          }
          
          // Update branch title
          updateBranchTitle();
        }
      } catch (error) {
        console.error('Error loading manager branch:', error);
      }
    }

    // Load notifications from API
    async function loadNotifications() {
      try {
        // Get branch_id from template variables or URL parameters
        const branchId = {{ branch_id if branch_id else 'null' }} || 
                        new URLSearchParams(window.location.search).get('branch') || 
                        new URLSearchParams(window.location.search).get('branch_id');
        
        let apiUrl = '/manager/api/notifications';
        if (branchId) {
          apiUrl += `?branch_id=${branchId}`;
        }
        
        console.log('Loading notifications for branch:', branchId, 'URL:', apiUrl);
        
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.ok && data.notifications) {
          renderNotifications(data.notifications);
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
        // Fallback to static content if API fails
      }
    }

    // Render notifications from API data
    function renderNotifications(notifications) {
      // Clear existing static content
      document.getElementById('systemAlerts').innerHTML = '';
      document.getElementById('branchAnnouncements').innerHTML = '';
      
      if (!notifications || notifications.length === 0) {
        // Show empty state
        document.getElementById('systemAlerts').innerHTML = `
          <div class="notification-item info">
            <div class="notification-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-content">
              <h4>No Notifications</h4>
              <p>You have no new notifications at this time.</p>
              <span class="notification-time">Just now</span>
            </div>
          </div>
        `;
        return;
      }

      // Group notifications by type
      const systemAlerts = notifications.filter(n => n.type === 'low_stock_alert');
      const branchAnnouncements = notifications.filter(n => n.type === 'manual_message');

      // Render system alerts
      systemAlerts.forEach(notification => {
        const alertElement = createNotificationElement(notification, 'alert');
        document.getElementById('systemAlerts').appendChild(alertElement);
      });

      // Render branch announcements
      branchAnnouncements.forEach(notification => {
        const announcementElement = createNotificationElement(notification, 'info');
        document.getElementById('branchAnnouncements').appendChild(announcementElement);
      });
    }

    // Create notification element from API data
    function createNotificationElement(notification, type) {
      const div = document.createElement('div');
      div.className = `notification-item ${notification.status === 'unread' ? 'unread' : ''} ${type}`;
      div.onclick = () => toggleNotification(div);
      
      const icon = type === 'alert' ? 'fa-exclamation-triangle' : 'fa-bullhorn';
      const timeAgo = getTimeAgo(notification.created_at);
      
      div.innerHTML = `
        <div class="notification-icon">
          <i class="fas ${icon}"></i>
        </div>
        <div class="notification-content">
          <h4>${formatNotificationType(notification.type)}</h4>
          <p>${notification.message}</p>
          <span class="notification-time">${timeAgo}</span>
        </div>
        <div class="notification-actions">
          <button class="btn-icon" onclick="markAsRead(event, this, ${notification.id})" title="Mark as Read">
            <i class="fas fa-check"></i>
          </button>
          <button class="btn-icon" onclick="archiveNotification(event, this, ${notification.id})" title="Archive">
            <i class="fas fa-archive"></i>
          </button>
        </div>
      `;
      
      return div;
    }

    // Format notification type for display
    function formatNotificationType(type) {
      const typeMap = {
        'low_stock_alert': 'Low Stock Alert',
        'manual_message': 'Branch Announcement',
        'expiry_notice': 'Expiry Notice',
        'delivery_delay': 'Delivery Delay',
        'forecast_spike': 'Forecast Spike'
      };
      return typeMap[type] || type;
    }

    // Get time ago string
    function getTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    }

    // Start polling for new notifications
    function startNotificationPolling() {
      // Check every 30 seconds for new notifications
      notificationCheckInterval = setInterval(async () => {
        await checkForNewNotifications();
      }, 30000);
    }

    // Check for new notifications and show popup
    async function checkForNewNotifications() {
      try {
        // Get branch_id for the API call
        const branchId = {{ branch_id if branch_id else 'null' }} || 
                        new URLSearchParams(window.location.search).get('branch') || 
                        new URLSearchParams(window.location.search).get('branch_id');
        
        let apiUrl = '/manager/api/notifications/unread-count';
        if (branchId) {
          apiUrl += `?branch_id=${branchId}`;
        }
        
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.ok && data.unread_count > 0) {
          showNewNotificationPopup(data.unread_count);
        }
      } catch (error) {
        console.error('Error checking for new notifications:', error);
      }
    }

    // Show popup notification for new messages
    function showNewNotificationPopup(count) {
      // Don't show if already on notifications page
      if (window.location.pathname.includes('/notifications')) {
        return;
      }

      // Create popup element
      const popup = document.createElement('div');
      popup.className = 'notification-popup';
      popup.innerHTML = `
        <div class="popup-content">
          <div class="popup-icon">
            <i class="fas fa-bell"></i>
          </div>
          <div class="popup-text">
            <h4>New Notification${count > 1 ? 's' : ''}</h4>
            <p>You have ${count} new notification${count > 1 ? 's' : ''} from Admin</p>
          </div>
          <button class="popup-close" onclick="closeNotificationPopup(this)">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="popup-actions">
          <button class="btn primary" onclick="goToNotifications()">View Notifications</button>
          <button class="btn secondary" onclick="closeNotificationPopup(this)">Dismiss</button>
        </div>
      `;
      
      // Add styles
      popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 320px;
        max-width: 400px;
        animation: slideInRight 0.3s ease-out;
      `;
      
      // Add CSS animation
      if (!document.getElementById('notification-popup-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-popup-styles';
        style.textContent = `
          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          .notification-popup .popup-content {
            display: flex;
            align-items: center;
            padding: 1rem;
            gap: 0.75rem;
          }
          .notification-popup .popup-icon {
            background: #3b82f6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
          }
          .notification-popup .popup-text {
            flex: 1;
          }
          .notification-popup .popup-text h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
          }
          .notification-popup .popup-text p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
          }
          .notification-popup .popup-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s;
          }
          .notification-popup .popup-close:hover {
            color: #6b7280;
          }
          .notification-popup .popup-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0 1rem 1rem 1rem;
          }
          .notification-popup .btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
          }
          .notification-popup .btn.primary {
            background: #3b82f6;
            color: white;
            border: none;
          }
          .notification-popup .btn.primary:hover {
            background: #2563eb;
          }
          .notification-popup .btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
          }
          .notification-popup .btn.secondary:hover {
            background: #e5e7eb;
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(popup);
      
      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (popup.parentNode) {
          popup.remove();
        }
      }, 10000);
    }

    // Close notification popup
    function closeNotificationPopup(element) {
      const popup = element.closest('.notification-popup');
      if (popup) {
        popup.remove();
      }
    }

    // Go to notifications page
    function goToNotifications() {
      // Preserve branch parameters when navigating to notifications
      const urlParams = new URLSearchParams(window.location.search);
      const branchId = urlParams.get('branch');
      const branchName = urlParams.get('branch_name');
      
      let notificationsUrl = '/manager/notifications';
      if (branchId && branchName) {
        notificationsUrl += `?branch=${branchId}&branch_name=${encodeURIComponent(branchName)}`;
      }
      
      window.location.href = notificationsUrl;
    }

    function filterNotifications() {
      const type = document.getElementById('typeFilter').value;
      const status = document.getElementById('statusFilter').value;
      document.querySelectorAll('.notification-item').forEach(n => {
        const nType =
          n.classList.contains('alert') ? 'alert' :
          n.classList.contains('update') ? 'update' : 'info';
        const nStatus = n.classList.contains('unread') ? 'unread' : 'read';
        const typeOK = type === 'all' || nType === type;
        const statusOK = status === 'all' || nStatus === status;
        n.style.display = (typeOK && statusOK) ? 'flex' : 'none';
      });
    }

    function toggleNotification(el) { el.classList.toggle('expanded'); }

    async function markAsRead(e, btn, notificationId) {
      e.stopPropagation();
      
      try {
        const response = await fetch(`/manager/api/notifications/${notificationId}/read`, {
          method: 'PATCH'
        });
        const data = await response.json();
        
        if (data.ok) {
      const item = btn.closest('.notification-item');
      item.classList.remove('unread');
      toast('Notification marked as read', 'success');
          
          // Clear popup tracking since user has read a notification
          sessionStorage.removeItem('lastNotificationPopup');
          sessionStorage.removeItem('lastUnreadCount');
        } else {
          toast('Error marking notification as read', 'error');
        }
      } catch (error) {
        console.error('Error marking notification as read:', error);
        toast('Error marking notification as read', 'error');
      }
    }

    async function archiveNotification(e, btn, notificationId) {
      e.stopPropagation();
      
      try {
        const response = await fetch(`/manager/api/notifications/${notificationId}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.ok) {
      const item = btn.closest('.notification-item');
      item.style.display = 'none';
      toast('Notification archived', 'success');
        } else {
          toast('Error archiving notification', 'error');
        }
      } catch (error) {
        console.error('Error archiving notification:', error);
        toast('Error archiving notification', 'error');
      }
    }

    async function markAllAsRead() {
      try {
        // Mark all unread notifications as read via API
        const unreadItems = document.querySelectorAll('.notification-item.unread');
        const promises = Array.from(unreadItems).map(item => {
          const notificationId = item.dataset.notificationId;
          if (notificationId) {
            return fetch(`/manager/api/notifications/${notificationId}/read`, {
              method: 'PATCH'
            });
          }
          return Promise.resolve();
        });
        
        await Promise.all(promises);
        
        // Update UI
        unreadItems.forEach(item => {
          item.classList.remove('unread');
        });
        
        // Clear popup tracking since all notifications are read
        sessionStorage.removeItem('lastNotificationPopup');
        sessionStorage.removeItem('lastUnreadCount');
        
      toast('All notifications marked as read', 'success');
      } catch (error) {
        console.error('Error marking all notifications as read:', error);
        toast('Error marking all notifications as read', 'error');
      }
    }

    function clearAllNotifications() {
      if (!confirm('Clear all notifications?')) return;
      document.querySelectorAll('.notification-item')
        .forEach(n => n.style.display = 'none');
      toast('All notifications cleared', 'success');
    }

    function toast(message, type='info') {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `
        <i class="fas ${
          type === 'success' ? 'fa-check-circle' :
          type === 'error'   ? 'fa-exclamation-circle' :
          'fa-info-circle'
        }"></i>
        <span>${message}</span>`;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // Update title and header based on branch selection
    function updateBranchTitle() {
      const branchName = '{{ branch_name if branch_name else "" }}' || new URLSearchParams(window.location.search).get('branch_name');
      const branchId = {{ branch_id if branch_id else 'null' }} || new URLSearchParams(window.location.search).get('branch');
      
      if (branchName) {
        const decodedBranchName = decodeURIComponent(branchName);
        document.getElementById('pageTitle').textContent = `Notifications - G.M.C. Rice Warehouse - ${decodedBranchName} Branch`;
        document.getElementById('branchTitle').textContent = `G.M.C. Rice Warehouse - ${decodedBranchName} Branch`;
        
        // Update all navigation links to preserve branch parameters
        updateNavigationLinks(branchId, branchName);
      } else {
        // Fallback to default title if no branch name
        document.getElementById('pageTitle').textContent = `Notifications - G.M.C. Rice Warehouse`;
        document.getElementById('branchTitle').textContent = `G.M.C. Rice Warehouse`;
      }
    }

    // Update navigation links to include branch parameters
    function updateNavigationLinks(branchId, branchName) {
      const navLinks = document.querySelectorAll('.nav-main a[href]');
      navLinks.forEach(link => {
        const currentHref = link.getAttribute('href');
        if (currentHref && !currentHref.includes('branch=')) {
          const separator = currentHref.includes('?') ? '&' : '?';
          link.href = `${currentHref}${separator}branch=${branchId}&branch_name=${encodeURIComponent(branchName)}`;
        }
      });
    }

    // Call the function when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Check if we have branch parameters, if not, try to get them
      const urlParams = new URLSearchParams(window.location.search);
      if (!urlParams.get('branch') || !urlParams.get('branch_name')) {
        // Branch parameters missing, will be loaded by initNotifications()
        console.log('Branch parameters missing, will be loaded from API');
      } else {
        // Branch parameters present, update title immediately
        updateBranchTitle();
      }
    });
  </script>
</body>
</html>
