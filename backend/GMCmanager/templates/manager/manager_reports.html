<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="pageTitle">Reports - G.M.C. Rice Warehouse</title>
<link rel="stylesheet" href="{{ url_for('manager.static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('manager.static', filename='css/reports.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="navbar">
  <div class="nav-brand"><h1 id="branchTitle">G.M.C. Rice Warehouse</h1></div>

  <div class="nav-main">
    <div class="nav-section">
      <h2>Main Menu</h2>
      <ul>
        <li><a href="{{ url_for('manager.manager_dashboard') }}"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="{{ url_for('manager.inventory') }}"><i class="fas fa-box"></i> Inventory</a></li>
        <li><a href="{{ url_for('manager.forecast') }}"><i class="fas fa-chart-line"></i> Forecast</a></li>
        <li><a href="{{ url_for('manager.sales') }}"><i class="fas fa-shopping-cart"></i> Sales</a></li>
        <li><a href="{{ url_for('manager.purchase') }}"><i class="fas fa-shopping-bag"></i> Purchase</a></li>
      </ul>
    </div>

    <div class="nav-section">
      <h2>Reports</h2>
      <ul>
        <li><a class="active" href="{{ url_for('manager.reports') }}"><i class="fas fa-file-alt"></i> All Reports</a></li>
        <li><a href="{{ url_for('manager.analytics') }}"><i class="fas fa-chart-bar"></i> Analytics</a></li>
      </ul>
    </div>

    <div class="nav-section">
      <h2>Settings</h2>
      <ul>
        <li><a href="{{ url_for('manager.notifications') }}"><i class="fas fa-bell"></i> Notifications</a></li>
        <li><a href="{{ url_for('manager.settings') }}"><i class="fas fa-cog"></i> Account Settings</a></li>
      </ul>
    </div>
  </div>
</nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="reports-container">
        <div class="reports-header">
          <h2>Reports</h2>
          <div class="reports-actions">
            <button class="btn primary" onclick="exportSales()"><i class="fas fa-download"></i> Export Sales (CSV)</button>
          </div>
        </div>

        <!-- Report Categories -->
        <div class="report-categories">
          <div class="category-section">
            <h3>Forecast Reports</h3>
            <div class="report-cards">
              <!-- Demand -->
              <div class="report-card">
                <div class="report-icon">
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="report-info">
                  <h4>Demand Forecast Report</h4>
                  <p>Shows forecasted demand per product and date</p>
                  <div class="report-filters">
                    <select id="demandDateRange">
                      <option value="7">Last 7 Days</option>
                      <option value="30">Last 30 Days</option>
                      <option value="90">Last 3 Months</option>
                    </select>
                    <select id="demandProduct">
                      <option value="">All Products</option>
                    </select>
                  </div>
                  <div class="report-actions">
                    <button class="btn secondary" onclick="exportReport('demand','pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn secondary" onclick="exportReport('demand','excel')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn secondary" onclick="exportReport('demand','csv')"><i class="fas fa-file-csv"></i> CSV</button>
                  </div>
                </div>
              </div>

              <!-- Price -->
              <div class="report-card">
                <div class="report-icon">
                  <i class="fas fa-tags"></i>
                </div>
                <div class="report-info">
                  <h4>Price Forecast Report</h4>
                  <p>Shows forecasted price trends and recommendations</p>
                  <div class="report-filters">
                    <select id="priceDateRange">
                      <option value="7">Last 7 Days</option>
                      <option value="30">Last 30 Days</option>
                      <option value="90">Last 3 Months</option>
                    </select>
                    <select id="priceCategory">
                      <option value="">All Categories</option>
                    </select>
                  </div>
                  <div class="report-actions">
                    <button class="btn secondary" onclick="exportReport('price','pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn secondary" onclick="exportReport('price','excel')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn secondary" onclick="exportReport('price','csv')"><i class="fas fa-file-csv"></i> CSV</button>
                  </div>
                </div>
              </div>

              <!-- Risk -->
              <div class="report-card">
                <div class="report-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="report-info">
                  <h4>Stock Risk Forecast</h4>
                  <p>Identifies potential stock risks and shortages</p>
                  <div class="report-filters">
                    <select id="riskDateRange">
                      <option value="7">Next 7 Days</option>
                      <option value="30">Next 30 Days</option>
                      <option value="90">Next 3 Months</option>
                    </select>
                    <select id="riskLevel">
                      <option value="">All Risk Levels</option>
                      <option value="high">High Risk</option>
                      <option value="medium">Medium Risk</option>
                      <option value="low">Low Risk</option>
                    </select>
                  </div>
                  <div class="report-actions">
                    <button class="btn secondary" onclick="exportReport('risk','pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn secondary" onclick="exportReport('risk','excel')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn secondary" onclick="exportReport('risk','csv')"><i class="fas fa-file-csv"></i> CSV</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Inventory -->
          <div class="category-section">
            <h3>Inventory Reports</h3>
            <div class="report-cards">
              <div class="report-card">
                <div class="report-icon"><i class="fas fa-box"></i></div>
                <div class="report-info">
                  <h4>Inventory Report</h4>
                  <p>Current stock levels and movement history</p>
                  <div class="report-filters">
                    <select id="inventoryDateRange">
                      <option value="7">Last 7 Days</option>
                      <option value="30">Last 30 Days</option>
                      <option value="90">Last 3 Months</option>
                    </select>
                    <select id="inventoryCategory">
                      <option value="">All Categories</option>
                    </select>
                  </div>
                  <div class="report-actions">
                    <button class="btn secondary" onclick="exportReport('inventory','pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn secondary" onclick="exportReport('inventory','excel')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn secondary" onclick="exportReport('inventory','csv')"><i class="fas fa-file-csv"></i> CSV</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sales -->
          <div class="category-section">
            <h3>Sales Reports</h3>
            <div class="report-cards">
              <div class="report-card">
                <div class="report-icon"><i class="fas fa-shopping-cart"></i></div>
                <div class="report-info">
                  <h4>Sales Report</h4>
                  <p>Sales performance and trends analysis</p>
                  <div class="report-filters">
                    <select id="salesDateRange">
                      <option value="7">Last 7 Days</option>
                      <option value="30">Last 30 Days</option>
                      <option value="90">Last 3 Months</option>
                    </select>
                    <select id="salesBranch">
                      <option value="">All Branches</option>
                    </select>
                  </div>
                  <div class="report-actions">
                    <button class="btn secondary" onclick="exportReport('sales','pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn secondary" onclick="exportReport('sales','excel')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn secondary" onclick="exportReport('sales','csv')"><i class="fas fa-file-csv"></i> CSV</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Export History -->
        <div class="export-history">
          <h3>Export History</h3>
          <div class="table-container">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Report Name</th>
                  <th>Generated By</th>
                  <th>Date Generated</th>
                  <th>File Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="exportHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/main.js"></script>
  <script>
    // --------- Page Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      initReports();
    });

    function initReports() {
      updateBranchTitle();
      loadSales();
    }

    // --------- Data / Rendering ----------
    async function loadSales(page = 1) {
      const urlParams = new URLSearchParams(window.location.search);
      const branchId = urlParams.get('branch') || urlParams.get('branch_id');
      const params = new URLSearchParams({ page: String(page), page_size: '50' });
      if (branchId) params.set('branch_id', branchId);
      const res = await fetch(`/manager/api/reports/sales?${params.toString()}`);
      const data = await res.json();
      if (!data.ok) return;
      const tbody = document.getElementById('exportHistoryBody');
      tbody.innerHTML = '';
      data.rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>Sales</td>
          <td>Branch</td>
          <td>${r.date}</td>
          <td>CSV</td>
          <td><span class="status completed">Loaded</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --------- Filters ----------
    function setupReportFilters() {
      const dateRanges = document.querySelectorAll('select[id$="DateRange"]');
      dateRanges.forEach(sel => {
        sel.addEventListener('change', () => {
          // Hook up to refresh data per card if needed
          console.log(`Date range changed for ${sel.id}: ${sel.value}`);
        });
      });
    }

    // --------- Actions ----------
    function exportSales() {
      const urlParams = new URLSearchParams(window.location.search);
      const branchId = urlParams.get('branch') || urlParams.get('branch_id');
      const params = new URLSearchParams({ format: 'csv' });
      if (branchId) params.set('branch_id', branchId);
      window.location.href = `/admin/api/reports/export/sales?${params.toString()}`;
    }

    function downloadReport(reportName) {
      try {
        showNotification(`Downloading ${reportName}...`, 'info');
        // TODO: real download logic
      } catch (err) {
        console.error(err);
        showNotification('Error downloading report', 'error');
      }
    }

    function scheduleExport() {
      try {
        // TODO: open scheduler modal / call API
        showNotification('Export scheduling feature coming soon', 'info');
      } catch (err) {
        console.error(err);
        showNotification('Error scheduling export', 'error');
      }
    }

    // --------- Utils (added to avoid undefined errors) ----------
    function formatDate(dateString) {
      const d = new Date(dateString);
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function showNotification(message, type = 'info') {
      const n = document.createElement('div');
      n.className = `notification ${type}`;
      n.innerHTML = `<i class="fas ${
        type === 'success' ? 'fa-check-circle' :
        type === 'error'   ? 'fa-exclamation-circle' :
        type === 'warning' ? 'fa-triangle-exclamation' : 'fa-info-circle'
      }"></i><span>${message}</span>`;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 2500);
    }

    // Update title and header based on branch selection
    function updateBranchTitle() {
      const urlParams = new URLSearchParams(window.location.search);
      const branchName = urlParams.get('branch_name');
      const branchId = urlParams.get('branch');
      
      if (branchName) {
        const decodedBranchName = decodeURIComponent(branchName);
        document.getElementById('pageTitle').textContent = `Reports - G.M.C. Rice Warehouse - ${decodedBranchName} Branch`;
        document.getElementById('branchTitle').textContent = `G.M.C. Rice Warehouse - ${decodedBranchName} Branch`;
        
        // Update all navigation links to preserve branch parameters
        updateNavigationLinks(branchId, branchName);
      }
    }

    // Update navigation links to include branch parameters
    function updateNavigationLinks(branchId, branchName) {
      const navLinks = document.querySelectorAll('.nav-main a[href]');
      navLinks.forEach(link => {
        const currentHref = link.getAttribute('href');
        if (currentHref && !currentHref.includes('branch=')) {
          const separator = currentHref.includes('?') ? '&' : '?';
          link.href = `${currentHref}${separator}branch=${branchId}&branch_name=${encodeURIComponent(branchName)}`;
        }
      });
    }

    // Call the function when page loads
    document.addEventListener('DOMContentLoaded', updateBranchTitle);
  </script>
</body>
</html>
