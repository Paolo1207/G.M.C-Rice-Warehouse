<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - G.M.C Rice Warehouse</title>
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/Sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/Dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="{{ url_for('admin.static', filename='js/dashboard.js') }}"></script>
</head>
<body>
    <!-- Sidebar directly embedded -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-top">
        <div class="sidebar-brand">
      <img src="{{ url_for('admin.static', filename='image/logo_of_gmc.png') }}" alt="GMC Logo" class="sidebar-logo-img">

        </div>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
          <svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke="#2e7d32" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <nav class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Main</div>
          <ul>
           <li class="active" title="Dashboard"><a href="{{ url_for('admin.admin_dashboard') }}"><span class="sidebar-icon"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="13" width="7" height="8" rx="2"/><rect x="14" y="3" width="7" height="18" rx="2"/></svg></span><span class="sidebar-label">Dashboard</span></a></li>
        <li title="Analytics"><a href="{{ url_for('admin.analytics') }}"><span class="sidebar-icon"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></span><span class="sidebar-label">Analytics</span></a></li>

          <li title="Forecast">
  <a href="{{ url_for('admin.forecast') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M3 17l6-6 4 4 8-8"/><path d="M14 7h7v7"/>
      </svg>
    </span>
    <span class="sidebar-label">Forecast</span>
  </a>
</li>
            <li title="Regional Insights">
  <a href="{{ url_for('admin.regional') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10A15.3 15.3 0 0 1 12 2z"/>
      </svg>
    </span>
    <span class="sidebar-label">Regional Insights</span>
  </a>
</li>
          </ul>
        </div>
        <div class="sidebar-section-divider"></div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Operations</div>
          <ul>
         <li title="Inventory">
  <a href="{{ url_for('admin.inventory') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="7" width="18" height="13" rx="2"/><path d="M16 3v4"/><path d="M8 3v4"/>
      </svg>
    </span>
    <span class="sidebar-label">Inventory</span>
  </a>
</li>
            <li title="Sales">
  <a href="{{ url_for('admin.sales') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M3 17l6-6 4 4 8-8"/>
      </svg>
    </span>
    <span class="sidebar-label">Sales</span>
  </a>
</li>
           
          </ul>
        </div>
        <div class="sidebar-section-divider"></div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Management</div>
          <ul>
          <li title="User Management">
  <a href="{{ url_for('admin.user') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="7" r="4"/><path d="M5.5 21a8.38 8.38 0 0 1 13 0"/>
      </svg>
    </span>
    <span class="sidebar-label">User Management</span>
  </a>
</li>
   <li title="Notifications">
  <a href="{{ url_for('admin.notifications') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
    </span>
    <span class="sidebar-label">Notifications</span>
  </a>
</li>

          </ul>
        </div>
      </nav>
      <div class="sidebar-profile" style="display: flex; align-items: center; justify-content: center; height: 25px;">
        <div class="sidebar-profile-info" style="text-align: center; width: 100%; display: flex; align-items: center; justify-content: center;">
          <div class="sidebar-profile-name sidebar-label" style="margin: 0 auto;">Admin</div>
        </div>
      </div>
      <div class="sidebar-bottom">
        <ul>
         <li title="Settings" style="display: flex; align-items: center; justify-content: center; height: 25px;">
  <a href="{{ url_for('admin.settings') }}" style="text-align: center; width: 100%; display: flex; align-items: center; justify-content: center;">
    <span class="sidebar-label" style="margin: 0 auto;">Settings</span>
  </a>
</li>
        </ul>
      </div>
    </aside>
    <script>
      // Sidebar collapse/expand logic
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      toggleBtn.onclick = () => {
        sidebar.classList.toggle('collapsed');
        document.body.classList.toggle('sidebar-collapsed', sidebar.classList.contains('collapsed'));
      };
    </script>
    <!-- End Sidebar -->
    <div class="main-content">
        <div class="dashboard-header">
            <div class="dashboard-title-section">
                <h2>üè† Dashboard</h2>
            </div>
        </div>

        <!-- Real-time Status Cards -->
        <div class="dashboard-cards-row">
            <div class="dashboard-card">
                <div class="card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="7" width="18" height="13" rx="2"/>
                        <path d="M16 3v4"/>
                        <path d="M8 3v4"/>
                    </svg>
                </div>
                <div class="card-content">
                <div class="dashboard-card-title">Today's Sales</div>
                    <div class="dashboard-card-value" id="today-sales">‚Ç±0</div>
                    <div class="dashboard-card-change positive">Real-time data</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="card-icon warning">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="card-content">
                <div class="dashboard-card-title">Low Stock Items</div>
                    <div class="dashboard-card-value" id="low-stock-count">0</div>
                    <div class="dashboard-card-change negative">Items below warning level</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                    </svg>
                </div>
                <div class="card-content">
                <div class="dashboard-card-title">Total Orders</div>
                    <div class="dashboard-card-value" id="total-orders">0</div>
                    <div class="dashboard-card-change positive">All branches</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </div>
                <div class="card-content">
                <div class="dashboard-card-title">Total Sales</div>
                    <div class="dashboard-card-value" id="month-sales">‚Ç±0</div>
                    <div class="dashboard-card-change">All-time total</div>
                </div>
            </div>
        </div>

        <!-- Alerts Row -->
        <div class="dashboard-widgets-row">
            <div class="dashboard-widget alerts-widget">
                <div class="widget-header">
                    <h3>üö® Alerts</h3>
                    <span class="alert-count" id="alert-count">0</span>
                </div>
                <div class="alerts-list" id="alerts-list">
                    <div class="alert-item loading">
                        <div class="alert-icon">‚è≥</div>
                        <div class="alert-content">
                            <div class="alert-title">Loading alerts...</div>
                            <div class="alert-desc">Fetching system alerts</div>
                        </div>
                        <div class="alert-time">--:--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Trend Chart -->
        <div class="dashboard-widgets-row">
            <div class="dashboard-widget-wide chart-widget">
                <div class="widget-header">
                    <h3>üìà Sales Trend</h3>
                    <div class="chart-controls">
                        <select class="chart-period" id="salesTrendPeriod">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                        <select class="branch-filter" id="salesTrendBranch">
                            <option value="">All Branches</option>
                            <option value="1">Marawoy</option>
                            <option value="2">Lipa</option>
                            <option value="3">Malvar</option>
                            <option value="4">Bulacnin</option>
                            <option value="5">Boac</option>
                            <option value="6">Sta. Cruz</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="salesTrendChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Current Rice Stock Chart -->
        <div class="dashboard-widgets-row">
            <div class="dashboard-widget-wide chart-widget">
                <div class="widget-header">
                    <h3>üì¶ Current Rice Stock</h3>
                    <div class="chart-controls">
                        <select class="branch-filter" id="riceStockBranch">
                            <option value="">All Branches</option>
                            <option value="1">Marawoy</option>
                            <option value="2">Lipa</option>
                            <option value="3">Malvar</option>
                            <option value="4">Bulacnin</option>
                            <option value="5">Boac</option>
                            <option value="6">Sta. Cruz</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="riceStockChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Predictive Demand Graph -->
        <div class="dashboard-widgets-row">
            <div class="dashboard-widget-wide chart-widget">
                <div class="widget-header">
                    <h3>üìà Predictive Demand Graph</h3>
                    <div class="chart-controls">
                        <select class="branch-filter" id="predictiveDemandBranch" required>
                            <option value="">Select Branch</option>
                            <option value="1" selected>Marawoy</option>
                            <option value="2">Lipa</option>
                            <option value="3">Malvar</option>
                            <option value="4">Bulacnin</option>
                            <option value="5">Boac</option>
                            <option value="6">Sta. Cruz</option>
                        </select>
                        <select class="branch-filter" id="predictiveDemandProduct" required style="display: none;">
                            <option value="">Select Product</option>
                        </select>
                        <select class="branch-filter" id="predictiveDemandBatch" style="display: none;">
                            <option value="">Please select a batch</option>
                        </select>
                        <select class="chart-period" id="predictiveDemandPeriod">
                            <option value="7">Next 7 days</option>
                            <option value="30" selected>Next 30 days</option>
                            <option value="90">Next 90 days</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="predictiveDemandChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Metrics Row -->
        <div class="dashboard-widgets-row">
            <div class="dashboard-widget metrics-widget">
                <div class="widget-header">
                    <h3>üìà Key Metrics</h3>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Sales by Month</div>
                        <div class="metric-value" id="revenue-value">‚Ç±0</div>
                        <div class="metric-change" id="revenue-change">+0%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Orders</div>
                        <div class="metric-value" id="orders-value">0</div>
                        <div class="metric-change" id="orders-change">+0%</div>
                    </div>
                    <div class="metric-item" style="position: relative;">
                        <div class="metric-label">
                            Avg Order Value
                            <span style="font-size: 10px; color: #666; margin-left: 4px; cursor: help;" title="Average amount per sales transaction. Calculated by dividing total sales by the number of orders in the current month.">‚ÑπÔ∏è</span>
                        </div>
                        <div class="metric-value" id="avg-order-value">‚Ç±0</div>
                        <div class="metric-change" id="avg-order-change">+0%</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px; font-style: italic;">Avg per transaction</div>
                    </div>
                </div>
            </div>
            <div class="dashboard-widget recent-activity-widget">
                <div class="widget-header">
                    <h3>üïí Recent Activity</h3>
                </div>
                <div class="activity-list" id="activityList">
                    <div class="activity-item loading">
                        <div class="activity-icon">‚è≥</div>
                        <div class="activity-content">
                            <div class="activity-title">Loading...</div>
                            <div class="activity-desc">Fetching recent activities</div>
                            <div class="activity-time">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Row -->
        <div class="dashboard-widgets-row">
            <div class="dashboard-widget quick-actions-widget">
                <div class="widget-header">
                    <h3>‚ö° Quick Actions</h3>
                    <div class="quick-actions-subtitle">Common tasks and shortcuts</div>
                </div>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn primary-action" onclick="window.location.href='{{ url_for('admin.inventory') }}'">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                        </div>
                        <div class="quick-action-content">
                            <div class="quick-action-title">Add New Product</div>
                            <div class="quick-action-desc">Create new inventory item</div>
                        </div>
                        <div class="quick-action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </button>
                    <button class="quick-action-btn" onclick="window.location.href='{{ url_for('admin.user') }}'">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="7" r="4"/>
                                <path d="M5.5 21a8.38 8.38 0 0 1 13 0"/>
                            </svg>
                        </div>
                        <div class="quick-action-content">
                            <div class="quick-action-title">Manage Users</div>
                            <div class="quick-action-desc">User permissions & roles</div>
                        </div>
                        <div class="quick-action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </button>
                    <button class="quick-action-btn" onclick="window.location.href='{{ url_for('admin.settings') }}'">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 12 5.1V5a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82v.09c0 .66.26 1.3.73 1.77z"/>
                            </svg>
                        </div>
                        <div class="quick-action-content">
                            <div class="quick-action-title">System Settings</div>
                            <div class="quick-action-desc">Configure preferences</div>
                        </div>
                        <div class="quick-action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </button>
                    <button class="quick-action-btn" onclick="window.location.href='{{ url_for('admin.sales') }}'">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 17l6-6 4 4 8-8"/>
                            </svg>
                        </div>
                        <div class="quick-action-content">
                            <div class="quick-action-title">Sales Management</div>
                            <div class="quick-action-desc">View sales data</div>
                        </div>
                        <div class="quick-action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </button>
                    <button class="quick-action-btn" onclick="window.location.href='{{ url_for('admin.forecast') }}'">
                        <div class="quick-action-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 17l6-6 4 4 8-8"/>
                                <path d="M14 7h7v7"/>
                            </svg>
                        </div>
                        <div class="quick-action-content">
                            <div class="quick-action-title">Forecast Analysis</div>
                            <div class="quick-action-desc">View predictions</div>
                        </div>
                        <div class="quick-action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </button>
                </div>
            </div>
            <div class="dashboard-widget system-status-widget">
                <div class="widget-header">
                    <h3>üîß System Status</h3>
                    <div class="status-refresh-btn" onclick="refreshSystemStatus()" title="Refresh Status">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                </div>
                </div>
                <div class="system-status-list" id="systemStatusList">
                    <div class="status-item" id="databaseStatus">
                        <div class="status-indicator"></div>
                        <div class="status-content">
                            <div class="status-title">Database</div>
                            <div class="status-desc">Checking connection...</div>
                        </div>
                        <div class="status-time" id="databaseTime">--:--</div>
                    </div>
                    <div class="status-item" id="apiStatus">
                        <div class="status-indicator"></div>
                        <div class="status-content">
                            <div class="status-title">API Services</div>
                            <div class="status-desc">Testing response time...</div>
                        </div>
                        <div class="status-time" id="apiTime">--:--</div>
                    </div>
                    <div class="status-item" id="inventoryStatus">
                        <div class="status-indicator"></div>
                        <div class="status-content">
                            <div class="status-title">Inventory System</div>
                            <div class="status-desc">Checking stock levels...</div>
                        </div>
                        <div class="status-time" id="inventoryTime">--:--</div>
                    </div>
                    <div class="status-item" id="forecastStatus">
                        <div class="status-indicator"></div>
                        <div class="status-content">
                            <div class="status-title">Forecast Engine</div>
                            <div class="status-desc">Validating models...</div>
                        </div>
                        <div class="status-time" id="forecastTime">--:--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>


        // Load KPI data from API
        async function loadKPIData() {
            try {
                // Use dashboard API for all KPIs (includes today_sales, month_sales, low_stock_count, forecast_accuracy)
                // This shows TOTAL across ALL branches for admin view
                const response = await fetch('/admin/api/dashboard/kpis');
                const data = await response.json();
                
                if (data.ok) {
                    const kpis = data.kpis;
                    
                    // Update all KPI cards with data from dashboard API
                    document.getElementById('today-sales').textContent = '‚Ç±' + (kpis.today_sales || 0).toLocaleString();
                    document.getElementById('month-sales').textContent = '‚Ç±' + (kpis.total_sales || kpis.month_sales || 0).toLocaleString();
                    document.getElementById('low-stock-count').textContent = kpis.low_stock_count || 0;
                    document.getElementById('total-orders').textContent = (kpis.total_orders || 0).toLocaleString();
                }
            } catch (error) {
                console.error('Error loading KPI data:', error);
            }
        }

        // Load Key Metrics data from API
        async function loadKeyMetrics() {
            try {
                const response = await fetch('/admin/api/dashboard/key-metrics');
                const data = await response.json();
                
                if (data.ok) {
                    const metrics = data.metrics;
                    
                    // Update revenue
                    document.getElementById('revenue-value').textContent = metrics.revenue.formatted;
                    updateMetricChange('revenue-change', metrics.revenue.change);
                    
                    // Update orders
                    document.getElementById('orders-value').textContent = metrics.orders.formatted;
                    updateMetricChange('orders-change', metrics.orders.change);
                    
                    // Update avg order value
                    document.getElementById('avg-order-value').textContent = metrics.avg_order_value.formatted;
                    updateMetricChange('avg-order-change', metrics.avg_order_value.change);
                }
            } catch (error) {
                console.error('Error loading key metrics:', error);
            }
        }

        // Update metric change indicator
        function updateMetricChange(elementId, change) {
            const element = document.getElementById(elementId);
            const isPositive = change >= 0;
            const sign = isPositive ? '+' : '';
            
            element.textContent = `${sign}${change.toFixed(1)}%`;
            element.className = `metric-change ${isPositive ? 'positive' : 'negative'}`;
        }

        // Load Recent Activity data from API
        async function loadRecentActivity() {
            try {
                const response = await fetch('/admin/api/dashboard/recent-activity');
                const data = await response.json();
                
                if (data.ok) {
                    const activities = data.activities;
                    const activityList = document.getElementById('activityList');
                    
                    // Clear loading state
                    activityList.innerHTML = '';
                    
                    // Add activities
                    activities.forEach(activity => {
                        const activityItem = document.createElement('div');
                        activityItem.className = 'activity-item';
                        activityItem.innerHTML = `
                            <div class="activity-icon">${activity.icon}</div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.title}</div>
                                <div class="activity-desc">${activity.description}</div>
                                <div class="activity-time">${activity.time_ago}</div>
                            </div>
                        `;
                        activityList.appendChild(activityItem);
                    });
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
                // Show error state
                const activityList = document.getElementById('activityList');
                activityList.innerHTML = `
                    <div class="activity-item error">
                        <div class="activity-icon">‚ö†Ô∏è</div>
                        <div class="activity-content">
                            <div class="activity-title">Error</div>
                            <div class="activity-desc">Failed to load activities</div>
                            <div class="activity-time">--:--</div>
                        </div>
                    </div>
                `;
            }
        }

        // Load all chart data (initial load)
        async function loadChartData() {
            await Promise.all([
                loadSalesTrendData(),
                loadRiceStockData()
            ]);
        }

        // Load Sales Trend data with its own filters
        async function loadSalesTrendData() {
            try {
                const salesTrendPeriod = document.getElementById('salesTrendPeriod')?.value || '30';
                const salesTrendBranch = document.getElementById('salesTrendBranch')?.value || '';

                const params = new URLSearchParams();
                if (salesTrendBranch) params.append('branch_id', salesTrendBranch);
                if (salesTrendPeriod) params.append('days', salesTrendPeriod);

                console.log('Loading Sales Trend with filters:', { salesTrendPeriod, salesTrendBranch });

                const response = await fetch(`/admin/api/dashboard/charts?${params.toString()}`);
                const data = await response.json();
                
                if (data.ok) {
                    updateSalesTrendChart(data.charts.sales_trend);
                    updateSalesTrendFilterDisplay();
                }
            } catch (error) {
                console.error('Error loading sales trend data:', error);
            }
        }

        // Load Current Rice Stock data
        async function loadRiceStockData() {
            try {
                const riceStockBranch = document.getElementById('riceStockBranch')?.value || '';

                const params = new URLSearchParams();
                if (riceStockBranch) params.append('branch_id', riceStockBranch);

                console.log('Loading Rice Stock with filters:', { riceStockBranch });

                const response = await fetch(`/admin/api/dashboard/rice-stock?${params.toString()}`);
                const data = await response.json();
                
                if (data.ok) {
                    updateRiceStockChart(data.stock_data);
                } else {
                    console.error('Error loading rice stock:', data.error);
                    updateRiceStockChart([]);
                }
            } catch (error) {
                console.error('Error loading rice stock data:', error);
                updateRiceStockChart([]);
            }
        }

        // Load products for predictive demand when branch is selected
        async function loadPredictiveDemandProducts() {
            const branchId = document.getElementById('predictiveDemandBranch')?.value || '';
            const productSelect = document.getElementById('predictiveDemandProduct');
            const batchSelect = document.getElementById('predictiveDemandBatch');
            
            if (!productSelect) return;
            
            if (!branchId) {
                productSelect.style.display = 'none';
                productSelect.innerHTML = '<option value="">Select Product</option>';
                if (batchSelect) {
                    batchSelect.style.display = 'none';
                    batchSelect.innerHTML = '<option value="">Please select a batch</option>';
                }
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/inventory?branch_id=${branchId}`);
                const data = await response.json();
                
                if (data.ok && data.items && data.items.length > 0) {
                    // Get unique products
                    const uniqueProducts = new Map();
                    data.items.forEach(item => {
                        const productId = item.product_id || item.id;
                        if (!uniqueProducts.has(productId)) {
                            uniqueProducts.set(productId, item);
                        }
                    });
                    
                    productSelect.innerHTML = '<option value="">Select Product</option>';
                    uniqueProducts.forEach((item, productId) => {
                        const option = document.createElement('option');
                        option.value = productId;
                        option.textContent = item.product_name || item.name || 'Unknown Product';
                        productSelect.appendChild(option);
                    });
                    
                    productSelect.style.display = 'block';
                } else {
                    productSelect.style.display = 'none';
                    productSelect.innerHTML = '<option value="">No products available</option>';
                }
                
                // Reset batch and product selection
                if (batchSelect) {
                    batchSelect.style.display = 'none';
                    batchSelect.innerHTML = '<option value="">Please select a batch</option>';
                }
                productSelect.value = '';
            } catch (error) {
                console.error('Error loading products:', error);
                productSelect.style.display = 'none';
                productSelect.innerHTML = '<option value="">Error loading products</option>';
            }
        }

        // Load batch codes for selected product
        async function loadPredictiveDemandBatches() {
            const branchId = document.getElementById('predictiveDemandBranch')?.value || '';
            const productId = document.getElementById('predictiveDemandProduct')?.value || '';
            const batchSelect = document.getElementById('predictiveDemandBatch');
            
            if (!batchSelect) return;
            
            if (!productId) {
                batchSelect.style.display = 'none';
                batchSelect.innerHTML = '<option value="">Please select a batch</option>';
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/products/${productId}/batch-codes?branch_id=${branchId}`);
                const data = await response.json();
                
                if (data.ok && data.batch_codes && data.batch_codes.length > 0) {
                    batchSelect.innerHTML = '<option value="">Please select a batch</option>';
                    data.batch_codes.forEach(batchCode => {
                        const option = document.createElement('option');
                        option.value = batchCode;
                        option.textContent = batchCode;
                        batchSelect.appendChild(option);
                    });
                    batchSelect.style.display = 'block';
                } else {
                    // No batches - hide the batch filter
                    batchSelect.style.display = 'none';
                    batchSelect.innerHTML = '<option value="">Please select a batch</option>';
                    // Auto-trigger forecast if no batches needed
                    loadPredictiveDemandData();
                }
            } catch (error) {
                console.error('Error loading batch codes:', error);
                batchSelect.style.display = 'none';
                batchSelect.innerHTML = '<option value="">Please select a batch</option>';
            }
        }

        // Load Predictive Demand Graph data
        async function loadPredictiveDemandData() {
            try {
                const branchId = document.getElementById('predictiveDemandBranch')?.value || '';
                const productId = document.getElementById('predictiveDemandProduct')?.value || '';
                const batchCode = document.getElementById('predictiveDemandBatch')?.value || '';
                const periods = parseInt(document.getElementById('predictiveDemandPeriod')?.value || '30');

                if (!branchId) {
                    updatePredictiveDemandChart([], 'Select a branch to generate forecast');
                    return;
                }

                if (!productId) {
                    updatePredictiveDemandChart([], 'Select a product to generate forecast');
                    return;
                }

                // Check if batch is required (batch filter is visible)
                const batchSelect = document.getElementById('predictiveDemandBatch');
                if (batchSelect && batchSelect.style.display !== 'none') {
                    if (!batchCode || batchCode === '') {
                        updatePredictiveDemandChart([], 'Select a batch to generate forecast');
                        return;
                    }
                }

                // Show loading state in chart
                updatePredictiveDemandChart([], 'Generating forecast...');

                // Use the forecast dashboard API with specific product
                let apiUrl = `/admin/api/forecast/dashboard?branch_id=${branchId}&product_id=${productId}&periods=${periods}`;
                // Note: batch_code filtering would need to be added to the backend if needed
                // For now, we'll just use product_id
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    let errorText = `Server error (${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) {
                        try {
                            const text = await response.text();
                            if (text && text.length < 200) {
                                errorText = text;
                            }
                        } catch (e2) {}
                    }
                    updatePredictiveDemandChart([], errorText);
                    return;
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    console.error('Error parsing JSON response:', jsonError);
                    updatePredictiveDemandChart([], 'Error parsing server response');
                    return;
                }
                
                if (data.ok && data.forecast) {
                    updatePredictiveDemandChart(data.forecast, null);
                } else {
                    updatePredictiveDemandChart([], data.error || 'No forecast data available');
                }
            } catch (error) {
                console.error('Error loading predictive demand:', error);
                updatePredictiveDemandChart([], `Error: ${error.message || 'Unknown error'}`);
            }
        }

        // Update Predictive Demand Chart
        function updatePredictiveDemandChart(forecast, errorMessage) {
            const ctx = document.getElementById('predictiveDemandChart');
            if (!ctx) return;

            if (window.predictiveDemandChart && typeof window.predictiveDemandChart.destroy === 'function') {
                window.predictiveDemandChart.destroy();
            }

            if (errorMessage || !forecast || !forecast.forecast_values || forecast.forecast_values.length === 0) {
                // Show error or empty state
                window.predictiveDemandChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            label: errorMessage || 'No forecast data',
                            data: [0],
                            borderColor: '#cccccc',
                            backgroundColor: 'rgba(204, 204, 204, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { 
                                display: true, 
                                text: errorMessage || 'No forecast data available',
                                font: { size: 14 }
                            }
                        }
                    }
                });
                return;
            }

            const forecastValues = forecast.forecast_values || [];
            const periods = forecastValues.length;
            
            // Generate date labels for the forecast period
            const labels = [];
            const today = new Date();
            for (let i = 1; i <= periods; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }

            window.predictiveDemandChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Predicted Demand (kg)',
                        data: forecastValues,
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#2e7d32',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: { size: 11 },
                                usePointStyle: true
                            }
                        },
                        title: { 
                            display: true, 
                            text: `Predictive Demand Forecast (Next ${periods} Days)`,
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#2e7d32',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return 'Demand: ' + context.parsed.y.toFixed(2) + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            title: { 
                                display: true, 
                                text: 'Demand (kg)',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' kg';
                                },
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Show loading state for charts
        function showChartLoadingState() {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                const canvas = container.querySelector('canvas');
                if (canvas) {
                    canvas.style.opacity = '0.5';
                }
            });
        }

        // Hide loading state for charts
        function hideChartLoadingState() {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                const canvas = container.querySelector('canvas');
                if (canvas) {
                    canvas.style.opacity = '1';
                }
            });
        }

        // Update filter display for Sales Trend
        function updateSalesTrendFilterDisplay() {
            const salesTrendBranch = document.getElementById('salesTrendBranch')?.value || '';
            const salesTrendPeriod = document.getElementById('salesTrendPeriod')?.value || '30';

            const salesTrendTitle = document.querySelector('#salesTrendChart').closest('.chart-widget')?.querySelector('.chart-subtitle');
            if (salesTrendTitle) {
                const branchText = salesTrendBranch ? ` - Branch ${salesTrendBranch}` : ' - All Branches';
                salesTrendTitle.textContent = `Sales Trend (Last ${salesTrendPeriod} days${branchText})`;
            }
        }


        // Branch color palette
        const branchColors = [
            { border: '#2e7d32', fill: 'rgba(46, 125, 50, 0.1)' },   // Green - Marawoy
            { border: '#1976d2', fill: 'rgba(25, 118, 210, 0.1)' }, // Blue - Lipa
            { border: '#f57c00', fill: 'rgba(245, 124, 0, 0.1)' },  // Orange - Malvar
            { border: '#7b1fa2', fill: 'rgba(123, 31, 162, 0.1)' }, // Purple - Bulacnin
            { border: '#c2185b', fill: 'rgba(194, 24, 91, 0.1)' },   // Pink - Boac
            { border: '#0288d1', fill: 'rgba(2, 136, 209, 0.1)' },   // Light Blue - Sta. Cruz
        ];

        // Update Sales Trend Chart
        function updateSalesTrendChart(data) {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;

            if (window.salesTrendChart && typeof window.salesTrendChart.destroy === 'function') {
                window.salesTrendChart.destroy();
            }

            // Check if data is branch-specific (array of branch objects) or aggregated (array of date objects)
            const isBranchSpecific = data && data.length > 0 && data[0].hasOwnProperty('branch_id');
            const salesTrendBranch = document.getElementById('salesTrendBranch')?.value || '';
            const selectedPeriod = document.getElementById('salesTrendPeriod')?.value || '30';

            let labels = [];
            let datasets = [];

            if (isBranchSpecific && !salesTrendBranch) {
                // All branches - multiple lines
                if (data.length === 0) {
                    labels = ['No Data'];
                    datasets = [{
                        label: 'No Data',
                        data: [0],
                        borderColor: '#cccccc',
                        backgroundColor: 'rgba(204, 204, 204, 0.1)',
                        borderWidth: 2,
                        fill: false
                    }];
                } else {
                    // Get all unique dates from all branches
                    const allDates = new Set();
                    data.forEach(branch => {
                        branch.data.forEach(item => allDates.add(item.date));
                    });
                    labels = Array.from(allDates).sort();

                    // Create dataset for each branch
                    data.forEach((branch, index) => {
                        const colorIndex = (branch.branch_id - 1) % branchColors.length;
                        const colors = branchColors[colorIndex];
                        
                        // Map branch data to labels
                        const branchData = labels.map(date => {
                            const item = branch.data.find(d => d.date === date);
                            return item ? item.sales : 0;
                        });

                        datasets.push({
                            label: branch.branch_name,
                            data: branchData,
                            borderColor: colors.border,
                            backgroundColor: colors.fill,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: colors.border,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        });
                    });
                }
            } else {
                // Single branch or aggregated - single line
                if (!data || data.length === 0) {
                    labels = ['No Data'];
                    datasets = [{
                        label: 'Daily Sales (‚Ç±)',
                        data: [0],
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }];
                } else {
                    labels = data.map(item => item.date);
                    const salesData = data.map(item => item.sales);
                    
                    datasets = [{
                        label: 'Daily Sales (‚Ç±)',
                        data: salesData,
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#2e7d32',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }];
                }
            }

            window.salesTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                    labels: labels,
                datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: {
                                    size: 11
                                },
                                usePointStyle: true
                            }
                        },
                        title: { 
                            display: true, 
                            text: `Sales Trend (Last ${selectedPeriod} Days)`,
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#2e7d32',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return '‚Ç±' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç±' + value.toLocaleString();
                                },
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Update Current Rice Stock Chart
        function updateRiceStockChart(data) {
            const ctx = document.getElementById('riceStockChart');
            if (!ctx) return;

            if (window.riceStockChart && typeof window.riceStockChart.destroy === 'function') {
                window.riceStockChart.destroy();
            }

            // Handle empty data
            if (!data || data.length === 0) {
                data = [{ product_name: 'No Data', stock_kg: 0 }];
            }

            const riceStockBranch = document.getElementById('riceStockBranch')?.value || '';
            const isAllBranches = !riceStockBranch;
            
            // Check if data has branch information
            const hasBranchInfo = data.length > 0 && (data[0].branch_name || data[0].branch_id);
            
            // Create labels with branch information when viewing all branches
            const labels = data.map(item => {
                if (isAllBranches && hasBranchInfo && item.branch_name) {
                    return `${item.product_name} - ${item.branch_name}`;
                }
                return item.product_name || item.name || 'Unknown';
            });
            const stockQuantities = data.map(item => item.stock_kg || item.quantity || 0);

            window.riceStockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Stock (kg)',
                        data: stockQuantities,
                        backgroundColor: stockQuantities.map(qty => {
                            // Color coding: green for good stock, yellow for medium, red for low
                            if (qty > 500) return 'rgba(46, 125, 50, 0.8)'; // Green
                            if (qty > 200) return 'rgba(245, 158, 11, 0.8)'; // Yellow/Orange
                            return 'rgba(220, 38, 38, 0.8)'; // Red
                        }),
                        borderColor: stockQuantities.map(qty => {
                            if (qty > 500) return '#2e7d32';
                            if (qty > 200) return '#f59e0b';
                            return '#dc2626';
                        }),
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        title: { 
                            display: true, 
                            text: 'Current Rice Stock by Product',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#2e7d32',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    const item = data[context[0].dataIndex];
                                    if (isAllBranches && hasBranchInfo && item.branch_name) {
                                        return `${item.product_name || item.name} (${item.branch_name})`;
                                    }
                                    return item.product_name || item.name || 'Unknown';
                                },
                                label: function(context) {
                                    const item = data[context.dataIndex];
                                    let label = 'Stock: ' + context.parsed.y.toLocaleString() + ' kg';
                                    
                                    if (isAllBranches && hasBranchInfo && item.branch_name) {
                                        label += '\nBranch: ' + item.branch_name;
                                    }
                                    
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            title: { 
                                display: true, 
                                text: 'Stock Quantity (kg)',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' kg';
                                },
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                font: { size: 11 },
                                maxRotation: isAllBranches && hasBranchInfo ? 45 : 0,
                                minRotation: isAllBranches && hasBranchInfo ? 45 : 0
                            }
                        }
                    }
                }
            });
        }


        // Load Alerts data
        async function loadAlerts() {
            try {
                const response = await fetch('/admin/api/dashboard/alerts');
                const data = await response.json();
                
                if (data.ok) {
                    const alerts = data.alerts;
                    const alertsList = document.getElementById('alerts-list');
                    const alertCount = document.getElementById('alert-count');
                    
                    // Update count
                    alertCount.textContent = data.total_count || alerts.length;
                    
                    // Clear loading state
                    alertsList.innerHTML = '';
                    
                    if (alerts.length === 0) {
                        alertsList.innerHTML = `
                            <div class="alert-item info">
                                <div class="alert-icon">‚úÖ</div>
                                <div class="alert-content">
                                    <div class="alert-title">All Clear</div>
                                    <div class="alert-desc">No alerts at this time</div>
                                </div>
                                <div class="alert-time">Just now</div>
                            </div>
                        `;
                    } else {
                        // Add alerts
                        alerts.forEach(alert => {
                            const alertItem = document.createElement('div');
                            alertItem.className = `alert-item ${alert.type}`;
                            alertItem.innerHTML = `
                                <div class="alert-icon">${alert.icon}</div>
                                <div class="alert-content">
                                    <div class="alert-title">${alert.title}</div>
                                    <div class="alert-desc">${alert.description}</div>
                                </div>
                                <div class="alert-time">${alert.time_ago}</div>
                            `;
                            alertsList.appendChild(alertItem);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
                const alertsList = document.getElementById('alerts-list');
                alertsList.innerHTML = `
                    <div class="alert-item warning">
                        <div class="alert-icon">‚ö†Ô∏è</div>
                        <div class="alert-content">
                            <div class="alert-title">Error</div>
                            <div class="alert-desc">Failed to load alerts</div>
                        </div>
                        <div class="alert-time">--:--</div>
                    </div>
                `;
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            await loadKPIData();
            await loadKeyMetrics();
            await loadRecentActivity();
            await loadAlerts();
            await loadChartData();
            
            // Add filter event listeners
            setupFilterListeners();
            
            // Refresh data every 5 minutes
            setInterval(async () => {
                await loadKPIData();
                await loadKeyMetrics();
                await loadRecentActivity();
                await loadAlerts();
                await loadChartData();
            }, 300000);
        }

        // Setup filter event listeners
        function setupFilterListeners() {
            // Sales trend filters
            const salesTrendPeriod = document.getElementById('salesTrendPeriod');
            const salesTrendBranch = document.getElementById('salesTrendBranch');
            
            if (salesTrendPeriod) {
                salesTrendPeriod.addEventListener('change', () => {
                    console.log('Sales Trend Period changed to:', salesTrendPeriod.value);
                    loadSalesTrendData();
                });
            }
            
            if (salesTrendBranch) {
                salesTrendBranch.addEventListener('change', () => {
                    console.log('Sales Trend Branch changed to:', salesTrendBranch.value);
                    loadSalesTrendData();
                });
            }

            // Rice Stock filter
            const riceStockBranch = document.getElementById('riceStockBranch');
            
            if (riceStockBranch) {
                riceStockBranch.addEventListener('change', () => {
                    console.log('Rice Stock Branch changed to:', riceStockBranch.value);
                    loadRiceStockData();
                });
            }

            // Predictive Demand Graph filters - auto-trigger on selection
            const predictiveDemandBranch = document.getElementById('predictiveDemandBranch');
            const predictiveDemandProduct = document.getElementById('predictiveDemandProduct');
            const predictiveDemandBatch = document.getElementById('predictiveDemandBatch');
            const predictiveDemandPeriod = document.getElementById('predictiveDemandPeriod');
            
            if (predictiveDemandBranch) {
                predictiveDemandBranch.addEventListener('change', async () => {
                    console.log('Predictive Demand Branch changed to:', predictiveDemandBranch.value);
                    await loadPredictiveDemandProducts();
                    // Reset product selection when branch changes
                    if (predictiveDemandProduct) {
                        predictiveDemandProduct.value = '';
                    }
                    if (predictiveDemandBatch) {
                        predictiveDemandBatch.value = '';
                        predictiveDemandBatch.style.display = 'none';
                    }
                });
            }

            if (predictiveDemandProduct) {
                predictiveDemandProduct.addEventListener('change', async () => {
                    console.log('Predictive Demand Product changed to:', predictiveDemandProduct.value);
                    await loadPredictiveDemandBatches();
                    // If no batches, forecast will auto-trigger from loadPredictiveDemandBatches
                });
            }

            if (predictiveDemandBatch) {
                predictiveDemandBatch.addEventListener('change', () => {
                    console.log('Predictive Demand Batch changed to:', predictiveDemandBatch.value);
                    // Auto-trigger forecast when batch is selected
                    if (predictiveDemandBatch.value) {
                        loadPredictiveDemandData();
                    }
                });
            }

            if (predictiveDemandPeriod) {
                predictiveDemandPeriod.addEventListener('change', () => {
                    console.log('Predictive Demand Period changed to:', predictiveDemandPeriod.value);
                    // Auto-trigger forecast when period changes (if product is already selected)
                    if (predictiveDemandProduct && predictiveDemandProduct.value) {
                        loadPredictiveDemandData();
                    }
                });
            }
            
            // Load products for initially selected branch
            if (predictiveDemandBranch && predictiveDemandBranch.value) {
                loadPredictiveDemandProducts();
            }
        }


        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', initializeDashboard);

        // Real-time System Status Monitoring
        let statusCheckInterval;

        async function checkSystemStatus() {
            const startTime = Date.now();
            
            // Check Database Status
            try {
                const dbResponse = await fetch('/admin/api/dashboard/kpis');
                const dbData = await dbResponse.json();
                updateStatusItem('databaseStatus', 'online', 'Database', 'All systems operational', startTime);
            } catch (error) {
                updateStatusItem('databaseStatus', 'error', 'Database', 'Connection failed', startTime);
            }

            // Check API Services
            try {
                const apiStart = Date.now();
                const apiResponse = await fetch('/admin/api/dashboard/charts');
                const apiTime = Date.now() - apiStart;
                updateStatusItem('apiStatus', 'online', 'API Services', `Response time: ${apiTime}ms`, startTime);
            } catch (error) {
                updateStatusItem('apiStatus', 'error', 'API Services', 'Service unavailable', startTime);
            }

            // Check Inventory System
            try {
                const inventoryResponse = await fetch('/admin/api/inventory/status');
                const inventoryData = await inventoryResponse.json();
                if (inventoryData.ok) {
                    updateStatusItem('inventoryStatus', 'online', 'Inventory System', `${inventoryData.total_products} products tracked`, startTime);
                } else {
                    updateStatusItem('inventoryStatus', 'warning', 'Inventory System', 'Some issues detected', startTime);
                }
            } catch (error) {
                updateStatusItem('inventoryStatus', 'error', 'Inventory System', 'System unavailable', startTime);
            }

            // Check Forecast Engine
            try {
                const forecastResponse = await fetch('/admin/api/forecast/status');
                const forecastData = await forecastResponse.json();
                if (forecastData.ok) {
                    updateStatusItem('forecastStatus', 'online', 'Forecast Engine', `${forecastData.model_count} models active`, startTime);
                } else {
                    updateStatusItem('forecastStatus', 'warning', 'Forecast Engine', 'Models updating', startTime);
                }
            } catch (error) {
                updateStatusItem('forecastStatus', 'error', 'Forecast Engine', 'Engine offline', startTime);
            }
        }

        function updateStatusItem(elementId, status, title, description, startTime) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            const titleElement = element.querySelector('.status-title');
            const descElement = element.querySelector('.status-desc');
            const timeElement = element.querySelector('.status-time');
            
            // Update status classes
            element.className = `status-item ${status}`;
            
            // Update content
            titleElement.textContent = title;
            descElement.textContent = description;
            
            // Update timestamp
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            timeElement.textContent = timeString;
        }

        function refreshSystemStatus() {
            // Show loading state
            document.querySelectorAll('.status-item').forEach(item => {
                item.className = 'status-item loading';
                const desc = item.querySelector('.status-desc');
                desc.textContent = 'Checking...';
            });
            
            // Check status
            checkSystemStatus();
        }

        function startStatusMonitoring() {
            // Initial check
            checkSystemStatus();
            
            // Set up interval for periodic checks (every 30 seconds)
            statusCheckInterval = setInterval(checkSystemStatus, 30000);
        }

        function stopStatusMonitoring() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        }

        // Initialize system status monitoring
        document.addEventListener('DOMContentLoaded', function() {
            startStatusMonitoring();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            stopStatusMonitoring();
        });
    </script>
</body>
</html>
</html>