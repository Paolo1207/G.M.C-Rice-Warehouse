<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - GMC Admin</title>
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/Sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/Analytics.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .custom-date-range {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .apply-btn {
            padding: 8px 16px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .apply-btn:hover {
            background: #1b5e20;
        }
    </style>
</head>
<body>
    <!-- Sidebar directly embedded -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-top">
        <div class="sidebar-brand">
        <img src="{{ url_for('admin.static', filename='image/logo_of_gmc.png') }}" alt="GMC Logo" class="sidebar-logo-img">

        </div>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
          <svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke="#2e7d32" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <nav class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Main</div>
          <ul>
          <li title="Dashboard">
  <a href="{{ url_for('admin.admin_dashboard') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="13" width="7" height="8" rx="2"/>
        <rect x="14" y="3" width="7" height="18" rx="2"/>
      </svg>
    </span>
    <span class="sidebar-label">Dashboard</span>
  </a>
</li>
           <li class="active" title="Analytics">
  <a href="{{ url_for('admin.analytics') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
      </svg>
    </span>
    <span class="sidebar-label">Analytics</span>
  </a>
</li>
           <li title="Forecast">
  <a href="{{ url_for('admin.forecast') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M3 17l6-6 4 4 8-8"/><path d="M14 7h7v7"/>
      </svg>
    </span>
    <span class="sidebar-label">Forecast</span>
  </a>
</li>

          <li title="Regional Insights">
  <a href="{{ url_for('admin.regional') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10A15.3 15.3 0 0 1 12 2z"/>
      </svg>
    </span>
    <span class="sidebar-label">Regional Insights</span>
  </a>
</li>

          </ul>
        </div>
        <div class="sidebar-section-divider"></div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Operations</div>
          <ul>
           <li title="Inventory">
  <a href="{{ url_for('admin.inventory') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="7" width="18" height="13" rx="2"/><path d="M16 3v4"/><path d="M8 3v4"/>
      </svg>
    </span>
    <span class="sidebar-label">Inventory</span>
  </a>
</li>
          <li title="Sales">
  <a href="{{ url_for('admin.sales') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M3 17l6-6 4 4 8-8"/>
      </svg>
    </span>
    <span class="sidebar-label">Sales</span>
  </a>
</li>

         
          </ul>
        </div>
        <div class="sidebar-section-divider"></div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Management</div>
          <ul>

           <li title="User Management">
  <a href="{{ url_for('admin.user') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="7" r="4"/><path d="M5.5 21a8.38 8.38 0 0 1 13 0"/>
      </svg>
    </span>
    <span class="sidebar-label">User Management</span>
  </a>
</li>
           <li title="Notifications">
  <a href="{{ url_for('admin.notifications') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
    </span>
    <span class="sidebar-label">Notifications</span>
  </a>
</li>
          </ul>
        </div>
      </nav>
      <div class="sidebar-profile" style="display: flex; align-items: center; justify-content: center; height: 25px;">
        <div class="sidebar-profile-info" style="text-align: center; width: 100%; display: flex; align-items: center; justify-content: center;">
          <div class="sidebar-profile-name" style="margin: 0 auto;">Admin</div>
        </div>
      </div>
      <div class="sidebar-bottom">
        <ul>
          <li title="Settings" style="display: flex; align-items: center; justify-content: center; height: 25px;">
  <a href="{{ url_for('admin.settings') }}" style="text-align: center; width: 100%; display: flex; align-items: center; justify-content: center;">
    <span class="sidebar-label" style="margin: 0 auto;">Settings</span>
  </a>
</li>
        </ul>
      </div>
    </aside>
    <script>
      // Sidebar collapse/expand logic
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      toggleBtn.onclick = () => {
        sidebar.classList.toggle('collapsed');
        document.body.classList.toggle('sidebar-collapsed', sidebar.classList.contains('collapsed'));
      };
    </script>
    <!-- End Sidebar -->
    <div class="main-content">
        <div class="analytics-header">
            <div class="analytics-title-section">
                <h2 class="analytics-title-gradient">üìä Analytics</h2>
                <div class="analytics-subtitle">Visual insights into warehouse and sales performance across all branches</div>
            </div>
            <div class="analytics-controls">
                <button class="export-btn" id="export-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export Data
                </button>
                <button class="export-btn" id="print-btn" style="margin-left: 10px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 6 2 18 2 18 9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                    Print
                </button>
            </div>
        </div>

        <!-- Key Metrics Row -->
        <div class="analytics-cards-row">
            <div class="analytics-card">
                <div class="card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 17l6-6 4 4 8-8"/>
                    </svg>
                </div>
                <div class="card-content">
                    <div class="analytics-card-title">Total Sales</div>
                    <div class="analytics-card-value" id="total-sales">‚Ç±0</div>
                    <div class="analytics-card-change positive">Real-time data</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="7" width="18" height="13" rx="2"/>
                        <path d="M16 3v4"/>
                        <path d="M8 3v4"/>
                    </svg>
                </div>
                <div class="card-content">
                    <div class="analytics-card-title">Units Sold</div>
                    <div class="analytics-card-value" id="units-sold">0</div>
                    <div class="analytics-card-change positive">This month</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </div>
                <div class="card-content">
                    <div class="analytics-card-title">Avg Order Value</div>
                    <div class="analytics-card-value" id="avg-order-value">‚Ç±0</div>
                    <div class="analytics-card-change positive">This month</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="card-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                    </svg>
                </div>
                <div class="card-content">
                    <div class="analytics-card-title">Total Orders</div>
                    <div class="analytics-card-value" id="total-orders">0</div>
                    <div class="analytics-card-change positive">All branches</div>
                </div>
            </div>
        </div>

        <!-- Total Stock per Branch Chart -->
        <div class="analytics-widgets-row">
            <div class="analytics-widget-wide chart-widget">
                <div class="widget-header">
                    <h3>üè¢ Total Stock per Branch</h3>
                    <div class="chart-controls">
                        <select class="chart-type-select" id="stockChartType">
                            <option value="bar" selected>Bar Chart</option>
                            <option value="cards">Cards View</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" id="stockChartContainer">
                    <canvas id="stockPerBranchChart" width="400" height="200"></canvas>
                </div>
                <div class="analytics-cards-row" id="stockCardsContainer" style="display:none"></div>
            </div>
        </div>

        <!-- Sales Trends Chart -->
        <div class="analytics-widgets-row">
            <div class="analytics-widget-wide chart-widget">
                <div class="widget-header">
                    <h3>üìà Sales Trends by Branch</h3>
                    <div class="chart-controls">
                        <select class="chart-period" id="salesPeriod">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                        <select class="region-select" id="salesBranchSelect">
                            <option value="" selected>All Branches</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="salesTrendsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Top-Selling Rice per Branch -->
        <div class="analytics-widgets-row">
            <div class="analytics-widget top-products-widget">
                <div class="widget-header">
                    <h3>üèÜ Top-Selling Rice per Branch</h3>
                    <div class="chart-controls">
                        <select class="chart-period" id="topProductsDateRange">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                
                <!-- Custom Date Range Inputs -->
                <div class="custom-date-range" id="topProductsCustomRange" style="display:none; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <input type="date" id="topProductsStartDate" class="date-input">
                    <span style="margin: 0 10px;">to</span>
                    <input type="date" id="topProductsEndDate" class="date-input">
                    <button class="apply-btn" onclick="applyTopProductsDateRange()">Apply</button>
                </div>
                
                <!-- Enhanced Branch Tabs -->
                <div class="branch-tabs">
                    <button class="branch-tab active" data-branch="marawoy">
                        <span>Marawoy</span>
                    </button>
                    <button class="branch-tab" data-branch="lipa">
                        <span>Lipa</span>
                    </button>
                    <button class="branch-tab" data-branch="malvar">
                        <span>Malvar</span>
                    </button>
                    <button class="branch-tab" data-branch="bulacnin">
                        <span>Bulacnin</span>
                    </button>
                    <button class="branch-tab" data-branch="boac">
                        <span>Boac</span>
                    </button>
                    <button class="branch-tab" data-branch="sta-cruz">
                        <span>Sta. Cruz</span>
                    </button>
                </div>
                
                <!-- Enhanced Product List -->
                <div class="top-products-list" id="topProductsList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading top products...</div>
                        </div>
                </div>
            </div>
        </div>

        
    </div>

    <script>
        // Load analytics data on page load
        document.addEventListener('DOMContentLoaded', async function() {
            setupOverviewFilters();
            await hydrateBranchMaps();
            wireBranchTabs();
            wireDaysFilter();
            loadAnalyticsData();
            // Load initial top products for Marawoy branch (ID: 1)
            loadTopProducts(1);
            
            // Setup export and print buttons
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    window.location.href = '/admin/api/reports/export/sales?format=csv';
                });
            }

            const printBtn = document.getElementById('print-btn');
            if (printBtn) {
                printBtn.addEventListener('click', function() {
                    printAnalyticsPage();
                });
            }
        });

        let BRANCH_ID_BY_NAME = {};
        let BRANCH_NAME_BY_ID = {};
        const normalizeName = (s) => (s||'').toString().toLowerCase().replace(/[^a-z0-9]/g,'');

        async function hydrateBranchMaps() {
            try {
                const r = await fetch('/admin/api/branches');
                const j = await r.json();
                if (j.ok && Array.isArray(j.branches)) {
                    BRANCH_ID_BY_NAME = {};
                    BRANCH_NAME_BY_ID = {};
                    j.branches.forEach(b => { BRANCH_ID_BY_NAME[b.name] = b.id; BRANCH_NAME_BY_ID[b.id] = b.name; });
                }
            } catch (e) { console.warn('hydrateBranchMaps failed', e); }
        }

        function wireBranchTabs() {
            const tabs = document.querySelectorAll('.branch-tab');
            tabs.forEach(tab => {
                const label = tab.textContent.trim();
                let bid = BRANCH_ID_BY_NAME[label];
                if (!bid) {
                    const norm = normalizeName(label);
                    const matching = Object.entries(BRANCH_ID_BY_NAME).find(([n]) => normalizeName(n) === norm);
                    if (matching) bid = matching[1];
                }
                if (bid) tab.dataset.branchId = bid;
                tab.addEventListener('click', async () => {
                    tabs.forEach(t=>t.classList.remove('active'));
                    tab.classList.add('active');
                    const id = tab.dataset.branchId;
                    const list = document.querySelector('.top-products-list');
                    if (list) list.innerHTML = '';
                    if (id) await loadTopProducts(id);
                });
            });
        }

        // Add event listener for days filter
        function wireDaysFilter() {
            const daysSelect = document.getElementById('topProductsDateRange');
            const customRangeDiv = document.getElementById('topProductsCustomRange');
            
            if (daysSelect) {
                daysSelect.addEventListener('change', async () => {
                    if (daysSelect.value === 'custom') {
                        if (customRangeDiv) customRangeDiv.style.display = 'flex';
                        // Set default dates to today
                        const today = new Date().toISOString().split('T')[0];
                        const startDateInput = document.getElementById('topProductsStartDate');
                        const endDateInput = document.getElementById('topProductsEndDate');
                        if (startDateInput) startDateInput.value = today;
                        if (endDateInput) endDateInput.value = today;
                    } else {
                        if (customRangeDiv) customRangeDiv.style.display = 'none';
                        const activeTab = document.querySelector('.branch-tab.active');
                        const branchId = activeTab ? activeTab.dataset.branchId : 1;
                        if (branchId) {
                            await loadTopProducts(branchId);
                        }
                    }
                });
            }
            
            // Add event listeners for custom date inputs
            const startDateInput = document.getElementById('topProductsStartDate');
            const endDateInput = document.getElementById('topProductsEndDate');
            if (startDateInput) {
                startDateInput.addEventListener('change', () => {
                    if (daysSelect && daysSelect.value === 'custom') {
                        applyTopProductsDateRange();
                    }
                });
            }
            if (endDateInput) {
                endDateInput.addEventListener('change', () => {
                    if (daysSelect && daysSelect.value === 'custom') {
                        applyTopProductsDateRange();
                    }
                });
            }
        }
        
        // Apply custom date range for top products
        async function applyTopProductsDateRange() {
            const startDate = document.getElementById('topProductsStartDate')?.value;
            const endDate = document.getElementById('topProductsEndDate')?.value;
            if (startDate && endDate) {
                const activeTab = document.querySelector('.branch-tab.active');
                const branchId = activeTab ? activeTab.dataset.branchId : 1;
                if (branchId) {
                    await loadTopProducts(branchId, startDate, endDate);
                }
            }
        }

        // Load analytics data from API
        async function loadAnalyticsData() {
            try {
                const daysSel = document.getElementById('dateRangeSelect');
                const days = daysSel ? parseInt(daysSel.value || '30', 10) : 30;
                
                // Load KPI data from the working sales API (30 days default)
                const kpiResponse = await fetch('/admin/api/sales/kpis');
                const kpiData = await kpiResponse.json();
                if (kpiData.ok) {
                    updateAnalyticsCards(kpiData.kpis);
                }
                
                // Also get low stock and forecast accuracy from dashboard API
                const dashboardResponse = await fetch('/admin/api/dashboard/kpis');
                const dashboardData = await dashboardResponse.json();
                if (dashboardData.ok) {
                    updateAnalyticsCardsAdditional(dashboardData.kpis);
                }

                // Load dashboard charts (top products etc.) as fallback for initial list
                const chartResponse = await fetch('/admin/api/dashboard/charts');
                const chartData = await chartResponse.json();
                if (chartData.ok) updateAnalyticsCharts(chartData.charts);

                // Load analytics overview (branch series, accuracy, stock, gaps)
                const overviewResponse = await fetch(`/admin/api/analytics/overview?days=${days}`);
                if (!overviewResponse.ok) {
                    const errorText = await overviewResponse.text();
                    console.error('Analytics API error:', overviewResponse.status, errorText);
                    throw new Error(`Server error: ${overviewResponse.status}`);
                }
                const overviewData = await overviewResponse.json();
                if (overviewData.ok && overviewData.analytics) {
                    const a = overviewData.analytics;
                    // store branch maps from overview too (non-destructive)
                    (a.stock_per_branch || []).forEach(b => { BRANCH_NAME_BY_ID[b.branch_id] = b.branch_name; BRANCH_ID_BY_NAME[b.branch_name] = b.branch_id; });
                    populateBranchSelect(a);
                    updateStockPerBranchChart(a.stock_per_branch || []);
                    updateSalesTrendsByBranch(a.sales_trends_by_branch || { labels: [], series: [] });
                    // initialize top products for the first branch if present
                    const firstBranchId = (a.stock_per_branch && a.stock_per_branch[0] && a.stock_per_branch[0].branch_id)
                        || (Object.keys(BRANCH_NAME_BY_ID)[0] ? Number(Object.keys(BRANCH_NAME_BY_ID)[0]) : null);
                    if (firstBranchId) { await loadTopProducts(firstBranchId); activateBranchTabById(firstBranchId); }
                } else {
                    console.error('Analytics API returned error:', overviewData.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
                // Show error message to user
                const stockContainer = document.getElementById('stockChartContainer');
                if (stockContainer) {
                    stockContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Failed to load stock data. Please refresh the page.</div>';
                }
                const salesContainer = document.querySelector('#salesTrendsChart')?.parentElement;
                if (salesContainer) {
                    salesContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Failed to load sales trends. Please refresh the page.</div>';
                }
            }
        }

        // Load analytics data with custom date range
        async function loadAnalyticsDataCustom(startDate, endDate) {
            try {
                console.log('Loading analytics data for custom range:', startDate, 'to', endDate);
                
                // Load KPI data from the working sales API with custom date range
                const kpiResponse = await fetch(`/admin/api/sales/kpis?start_date=${startDate}&end_date=${endDate}`);
                const kpiData = await kpiResponse.json();
                if (kpiData.ok) {
                    updateAnalyticsCards(kpiData.kpis);
                }
                
                // Also get low stock and forecast accuracy from dashboard API
                const dashboardResponse = await fetch('/admin/api/dashboard/kpis');
                const dashboardData = await dashboardResponse.json();
                if (dashboardData.ok) {
                    updateAnalyticsCardsAdditional(dashboardData.kpis);
                }

                // Load dashboard charts (top products etc.) as fallback for initial list
                const chartResponse = await fetch('/admin/api/dashboard/charts');
                const chartData = await chartResponse.json();
                if (chartData.ok) updateAnalyticsCharts(chartData.charts);

                // Load analytics overview with custom date range
                const overviewResponse = await fetch(`/admin/api/analytics/overview?start_date=${startDate}&end_date=${endDate}`);
                const overviewData = await overviewResponse.json();
                if (overviewData.ok && overviewData.analytics) {
                    const a = overviewData.analytics;
                    // store branch maps from overview too (non-destructive)
                    (a.stock_per_branch || []).forEach(b => { BRANCH_NAME_BY_ID[b.branch_id] = b.branch_name; BRANCH_ID_BY_NAME[b.branch_name] = b.branch_id; });
                    populateBranchSelect(a);
                    updateStockPerBranchChart(a.stock_per_branch || []);
                    updateSalesTrendsByBranch(a.sales_trends_by_branch || { labels: [], series: [] });
                    // initialize top products for the first branch if present
                    const firstBranchId = (a.stock_per_branch && a.stock_per_branch[0] && a.stock_per_branch[0].branch_id)
                        || (Object.keys(BRANCH_NAME_BY_ID)[0] ? Number(Object.keys(BRANCH_NAME_BY_ID)[0]) : null);
                    if (firstBranchId) { await loadTopProducts(firstBranchId); activateBranchTabById(firstBranchId); }
                }
            } catch (error) {
                console.error('Error loading custom analytics data:', error);
            }
        }

        // Update analytics cards with real data from sales API
        function updateAnalyticsCards(kpis) {
            // Update total sales (30 days)
            const totalSalesCard = document.getElementById('total-sales');
            if (totalSalesCard) {
                totalSalesCard.textContent = '‚Ç±' + (kpis.month_sales || 0).toLocaleString();
            }

            // Update units sold
            const unitsSoldCard = document.getElementById('units-sold');
            if (unitsSoldCard) {
                unitsSoldCard.textContent = (kpis.units_sold || 0).toLocaleString();
            }

            // Update avg order value
            const avgOrderValueCard = document.getElementById('avg-order-value');
            if (avgOrderValueCard) {
                avgOrderValueCard.textContent = '‚Ç±' + (kpis.avg_order_value || 0).toLocaleString();
            }
        }

        // Update additional analytics cards from dashboard API
        function updateAnalyticsCardsAdditional(kpis) {
            // Update total orders
            const totalOrdersCard = document.getElementById('total-orders');
            if (totalOrdersCard) {
                totalOrdersCard.textContent = (kpis.total_orders || 0).toLocaleString();
            }
        }

        // Update analytics charts with real data from dashboard charts API
        function updateAnalyticsCharts(charts) {
            if (charts.sales_trend && charts.sales_trend.length > 0) {
                // Keep existing card update for total sales trend if needed
                updateSalesTrendsChart(charts.sales_trend);
            }
            if (charts.top_products && charts.top_products.length > 0) {
                updateTopProductsAnalytics(charts.top_products);
            }
        }

        // Update Sales Trends Chart with real data
        function updateSalesTrendsChart(data) {
            const ctx = document.getElementById('salesTrendsChart');
            if (!ctx) return;

            if (window.salesTrendsChart && typeof window.salesTrendsChart.destroy === 'function') {
                window.salesTrendsChart.destroy();
                window.salesTrendsChart = null;
            }

            const labels = data.map(item => item.date);
            const salesData = data.map(item => item.sales);

            try {
                window.salesTrendsChart = new Chart(ctx, {
                    type: 'line',
            data: {
                        labels: labels,
                datasets: [{
                            label: 'Sales Trend (‚Ç±)',
                            data: salesData,
                            borderColor: '#2e7d32',
                            backgroundColor: 'rgba(46, 125, 50, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                            display: true,
                            position: 'top'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#2e7d32',
                        borderWidth: 1,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                    return '‚Ç±' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                    return '‚Ç±' + (value / 1000) + 'k';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)',
                            drawBorder: false
                        }
                    }
                }
            }
        });
        } catch (error) {
            console.error('Error creating sales trends chart:', error);
        }
        }

        // Update Top Products with real data
        function updateTopProductsAnalytics(data) {
            const productsList = document.querySelector('.top-products-list');
            if (!productsList) return;

            productsList.innerHTML = '';
            
            data.forEach((product, index) => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-rank">${index + 1}</div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-sales">${(product.quantity||0).toLocaleString()} kg sold</div>
                    </div>
                    <div class="product-revenue">‚Ç±${(product.sales||0).toLocaleString()}</div>
                    <div class="product-trend positive">+${(Math.random()*20+5).toFixed(1)}%</div>
                `;
                productsList.appendChild(productItem);
            });
        }

        async function loadTopProducts(branchId) {
            try {
                const res = await fetch(`/admin/api/dashboard/charts?branch_id=${branchId}`);
                const data = await res.json();
                if (data.ok && data.charts && data.charts.top_products) {
                    updateTopProductsAnalytics(data.charts.top_products);
                }
            } catch (e) { console.error('loadTopProducts failed', e); }
        }

        // Live charts instances
        let stockPerBranchChartInstance = null;
        let salesTrendsByBranchChartInstance = null;

        // Stock per Branch Chart (from overview API) + cards view toggle
        function updateStockPerBranchChart(rows) {
            const ctxEl = document.getElementById('stockPerBranchChart');
            if (!ctxEl) {
                console.error('Stock chart canvas element not found');
                return;
            }
            
            if (!rows || rows.length === 0) {
                console.warn('No stock data to display');
                ctxEl.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No stock data available</div>';
                return;
            }
            
            const ctx = ctxEl.getContext('2d');
            if (stockPerBranchChartInstance && typeof stockPerBranchChartInstance.destroy === 'function') {
                stockPerBranchChartInstance.destroy();
                stockPerBranchChartInstance = null;
            }
            const labels = rows.map(r => r.branch_name || `Branch ${r.branch_id}`);
            const data = rows.map(r => Number(r.total_stock_kg || 0));
            try {
                stockPerBranchChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Total Stock (kg)',
                            data,
                            backgroundColor: 'rgba(46, 125, 50, 0.8)',
                            borderColor: '#2e7d32',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#2e7d32',
                                borderWidth: 1,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return (context.parsed.y || 0).toLocaleString() + ' kg';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.1)', drawBorder: false },
                                ticks: { callback: v => v.toLocaleString() + ' kg' }
                            },
                            x: { grid: { color: 'rgba(0,0,0,0.1)', drawBorder: false } }
                        }
                    }
                });
                renderStockCards(rows);
            } catch (error) {
                console.error('Error creating stock per branch chart:', error);
                ctxEl.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Error displaying chart</div>';
            }
        }

        function renderStockCards(rows) {
            const cont = document.getElementById('stockCardsContainer');
            if (!cont) return;
            cont.innerHTML = '';
            rows.forEach(r => {
                const card = document.createElement('div');
                card.className = 'analytics-card';
                card.innerHTML = `
                  <div class="card-content">
                    <div class="analytics-card-title">${r.branch_name}</div>
                    <div class="analytics-card-value">${Number(r.total_stock_kg||0).toLocaleString()} kg</div>
                  </div>`;
                cont.appendChild(card);
            });
        }

        // Sales Trends by Branch (from overview API)
        function updateSalesTrendsByBranch(payload) {
            const ctxEl = document.getElementById('salesTrendsChart');
            if (!ctxEl) {
                console.error('Sales trends chart canvas element not found');
                return;
            }
            
            // Check if we have valid data
            if (!payload || !payload.labels || !payload.series || payload.series.length === 0) {
                console.warn('No sales trends data to display');
                const chartContainer = ctxEl.closest('.chart-container');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No sales data available for the selected period</div>';
                }
                return;
            }
            
            // Get the chart container to restore canvas if needed
            const chartContainer = ctxEl.closest('.chart-container');
            if (!chartContainer) {
                console.error('Chart container not found');
                return;
            }
            
            // Destroy existing chart instance FIRST before replacing canvas
            if (salesTrendsByBranchChartInstance) {
                try {
                    if (typeof salesTrendsByBranchChartInstance.destroy === 'function') {
                        salesTrendsByBranchChartInstance.destroy();
                    }
                } catch (e) {
                    console.warn('Error destroying chart during cleanup:', e);
                }
                salesTrendsByBranchChartInstance = null;
            }
            
            // Remove old canvas completely and create fresh one
            const oldCanvas = document.getElementById('salesTrendsChart');
            if (oldCanvas) {
                oldCanvas.remove();
            }
            
            // Create new canvas element
            const newCanvas = document.createElement('canvas');
            newCanvas.id = 'salesTrendsChart';
            newCanvas.width = 400;
            newCanvas.height = 200;
            chartContainer.innerHTML = '';
            chartContainer.appendChild(newCanvas);
            
            const ctx = newCanvas.getContext('2d');

            const labels = payload.labels || [];
            const colors = ['#2e7d32','#3b82f6','#f59e0b','#8b5cf6','#ec4899','#059669','#dc2626'];
            const datasets = (payload.series || []).map((s, i) => ({
                label: s.branch_name || `Branch ${s.branch_id}`,
                data: (s.data || []).map(v => Number(v) || 0),
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '1A',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }));

            try {
                salesTrendsByBranchChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#2e7d32',
                                borderWidth: 1,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ‚Ç±' + (context.parsed.y || 0).toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.1)', drawBorder: false },
                                ticks: { callback: v => '‚Ç±' + (v / 1000) + 'k' }
                            },
                            x: { grid: { color: 'rgba(0,0,0,0.1)', drawBorder: false } }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating sales trends by branch chart:', error);
                if (chartContainer) {
                    chartContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Error displaying sales trends chart</div>';
                }
            }
        }


        function populateBranchSelect(a) {
            const sel = document.getElementById('salesBranchSelect');
            if (!sel || !a.stock_per_branch) return;
            sel.innerHTML = '<option value="" selected>All Branches</option>';
            a.stock_per_branch.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.branch_id; opt.textContent = b.branch_name; sel.appendChild(opt);
            });
            // also stamp ids on top-products tabs for switching
            const tabs = document.querySelectorAll('.branch-tab');
            tabs.forEach(tab => {
                const name = tab.textContent.trim();
                // exact match
                let bid = BRANCH_ID_BY_NAME[name];
                if (!bid) {
                    // try normalized match
                    const norm = normalizeName(name);
                    const entry = (a.stock_per_branch||[]).find(b=> normalizeName(b.branch_name)===norm);
                    if (entry) bid = entry.branch_id;
                }
                if (bid) tab.dataset.branchId = bid;
                tab.addEventListener('click', async () => {
                    tabs.forEach(t=>t.classList.remove('active'));
                    tab.classList.add('active');
                    const id = tab.dataset.branchId || BRANCH_ID_BY_NAME[name];
                    if (id) await loadTopProducts(id);
                });
            });
        }

        function activateBranchTabById(branchId) {
            const tabs = document.querySelectorAll('.branch-tab');
            tabs.forEach(t=>{
                if (String(t.dataset.branchId) === String(branchId)) t.classList.add('active'); else t.classList.remove('active');
            });
        }

        function setupOverviewFilters() {
            const typeSel = document.getElementById('stockChartType');
            const chartContainer = document.getElementById('stockChartContainer');
            const cardsContainer = document.getElementById('stockCardsContainer');
            if (typeSel) {
                typeSel.addEventListener('change', () => {
                    if (typeSel.value === 'cards') {
                        chartContainer.style.display = 'none';
                        cardsContainer.style.display = '';
                    } else {
                        chartContainer.style.display = '';
                        cardsContainer.style.display = 'none';
                    }
                });
            }
            const periodSel = document.querySelector('#salesPeriod');
            const branchSel = document.querySelector('#salesBranchSelect');
            if (periodSel) periodSel.addEventListener('change', reloadSalesTrendsFiltered);
            if (branchSel) branchSel.addEventListener('change', reloadSalesTrendsFiltered);
            
            // Date range filter removed - using default 30 days
        }

        async function reloadSalesTrendsFiltered() {
            try {
                const period = document.getElementById('salesPeriod')?.value || 'daily';
                const branchId = document.getElementById('salesBranchSelect')?.value || '';
                const daysSel = document.getElementById('dateRangeSelect');
                const days = daysSel ? parseInt(daysSel.value || '30', 10) : 30;
                
                let url = `/admin/api/analytics/overview?days=${days}`;
                
                // Check if custom date range is selected
                if (daysSel && daysSel.value === 'custom') {
                    const startDate = document.getElementById('startDate')?.value;
                    const endDate = document.getElementById('endDate')?.value;
                    if (startDate && endDate) {
                        url = `/admin/api/analytics/overview?start_date=${startDate}&end_date=${endDate}`;
                    }
                }
                
                console.log('Loading sales trends with URL:', url, 'period:', period, 'branchId:', branchId);
                const res = await fetch(url);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Sales trends API error:', res.status, errorText);
                    throw new Error(`Server error: ${res.status}`);
                }
                
                const data = await res.json();
                if (!data.ok) {
                    console.error('Sales trends API returned error:', data.error);
                    return;
                }
                
                if (!data.analytics || !data.analytics.sales_trends_by_branch) {
                    console.error('No sales trends data in response');
                    return;
                }
                
                const payload = data.analytics.sales_trends_by_branch;
                let series = payload.series || [];
                
                // Filter by branch if specified
                if (branchId) {
                    series = series.filter(s => String(s.branch_id) === String(branchId));
                }
                
                // Resample based on period (daily/weekly/monthly)
                const processed = resampleSalesSeries(period, payload.labels || [], series);
                updateSalesTrendsByBranch(processed);
            } catch (e) { 
                console.error('reloadSalesTrendsFiltered error:', e);
                const chartContainer = document.querySelector('#salesTrendsChart')?.closest('.chart-container');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Failed to load sales trends. Please refresh the page.</div>';
                }
            }
        }

        function resampleSalesSeries(period, labels, series) {
            if (period === 'daily') return { labels, series };
            // convert date strings to Date
            const dates = labels.map(d => new Date(d));
            const bucketKey = (d) => {
                if (period === 'weekly') {
                    const tmp = new Date(d); const onejan = new Date(tmp.getFullYear(),0,1);
                    const week = Math.ceil((((tmp - onejan) / 86400000) + onejan.getDay()+1)/7);
                    return `${tmp.getFullYear()}-W${week}`;
                } else {
                    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                }
            };
            // build buckets
            const keys = dates.map(bucketKey);
            const uniqKeys = [...new Set(keys)];
            const remap = series.map(s => {
                const sums = new Array(uniqKeys.length).fill(0);
                (s.data||[]).forEach((v,i)=>{ const ki = uniqKeys.indexOf(keys[i]); if (ki>=0) sums[ki]+=Number(v||0); });
                return { branch_id: s.branch_id, branch_name: s.branch_name, data: sums };
            });
            return { labels: uniqKeys, series: remap };
        }

        function printAnalyticsPage() {
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            if (!printWindow) {
                alert('Please allow popups to use the print feature');
                return;
            }

            const generatedAt = new Date().toLocaleString();
            
            // Get chart images
            let stockChartImg = '';
            let salesChartImg = '';
            
            if (stockPerBranchChartInstance) {
                stockChartImg = stockPerBranchChartInstance.toBase64Image();
            }
            if (salesTrendsByBranchChartInstance) {
                salesChartImg = salesTrendsByBranchChartInstance.toBase64Image();
            }

            // Get KPI values
            const totalSales = document.getElementById('total-sales')?.textContent || '‚Ç±0';
            const unitsSold = document.getElementById('units-sold')?.textContent || '0';
            const avgOrderValue = document.getElementById('avg-order-value')?.textContent || '‚Ç±0';
            const totalOrders = document.getElementById('total-orders')?.textContent || '0';

            // Get top products
            const topProductsContainer = document.getElementById('topProductsList');
            let topProductsHTML = '';
            if (topProductsContainer) {
                topProductsHTML = topProductsContainer.innerHTML;
            }

            const printHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Analytics Report - Print</title>
    <style>
        @media print {
            @page { margin: 1cm; size: landscape; }
            .no-print { display: none !important; }
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #1f2937;
        }
        .header {
            border-bottom: 3px solid #2e7d32;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            color: #2e7d32;
            font-size: 24px;
        }
        .header p {
            margin: 4px 0;
            color: #64748b;
            font-size: 12px;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2e7d32;
        }
        .kpi-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 5px;
        }
        .kpi-value {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }
        .section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        .section h3 {
            color: #2e7d32;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .chart-img {
            width: 100%;
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        .top-products-list {
            margin-top: 10px;
        }
        .product-item {
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Analytics Report</h1>
        <p>Generated: ${generatedAt}</p>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Total Sales</div>
            <div class="kpi-value">${totalSales}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Units Sold</div>
            <div class="kpi-value">${unitsSold}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Avg Order Value</div>
            <div class="kpi-value">${avgOrderValue}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Orders</div>
            <div class="kpi-value">${totalOrders}</div>
        </div>
    </div>

    <div class="section">
        <h3>üè¢ Total Stock per Branch</h3>
        ${stockChartImg ? `<img src="${stockChartImg}" class="chart-img" alt="Stock per Branch Chart">` : '<p>Chart data not available</p>'}
    </div>

    <div class="section">
        <h3>üìà Sales Trends by Branch</h3>
        ${salesChartImg ? `<img src="${salesChartImg}" class="chart-img" alt="Sales Trends Chart">` : '<p>Chart data not available</p>'}
    </div>

    <div class="section">
        <h3>üèÜ Top-Selling Products</h3>
        <div class="top-products-list">
            ${topProductsHTML || '<p>No products data available</p>'}
        </div>
    </div>

    <div class="actions no-print">
        <button class="btn" onclick="window.print()">Print</button>
    </div>
</body>
</html>`;

            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
        }


        // Load top products for selected branch
        async function loadTopProducts(branchId, startDate = null, endDate = null) {
            try {
                const productsList = document.getElementById('topProductsList');
                if (!productsList) return;
                
                productsList.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">Loading top products...</div></div>';
                
                // Build query parameters
                const params = new URLSearchParams();
                if (branchId) params.append('branch_id', branchId);
                
                // Handle date range
                if (startDate && endDate) {
                    // Custom date range
                    params.append('from', startDate);
                    params.append('to', endDate);
                } else {
                    // Get the selected days from the top products dropdown
                    const daysSelect = document.getElementById('topProductsDateRange');
                    const days = daysSelect ? parseInt(daysSelect.value, 10) : 30;
                    
                    // Validate days is a number
                    if (isNaN(days) || days <= 0) {
                        console.error('Invalid days value:', daysSelect?.value);
                        productsList.innerHTML = '<div class="error-state">Invalid date range</div>';
                        return;
                    }
                    params.append('days', days);
                }
                
                console.log('Loading top products for branch:', branchId, 'params:', params.toString());
                const response = await fetch(`/admin/api/dashboard/charts?${params.toString()}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Top products API error:', response.status, errorText);
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.ok && data.charts && data.charts.top_products && data.charts.top_products.length > 0) {
                    console.log('Top products data:', data.charts.top_products);
                    updateProductList(data.charts.top_products);
                } else {
                    console.log('No products data in response for branch:', branchId);
                    productsList.innerHTML = '<div class="no-data">No products found for this branch in the selected date range</div>';
                }
            } catch (error) {
                console.error('Error loading top products:', error);
                const productsList = document.getElementById('topProductsList');
                if (productsList) {
                    productsList.innerHTML = '<div class="error-state">Failed to load products. Please try again.</div>';
                }
            }
        }

        function updateProductList(products) {
            const productsList = document.getElementById('topProductsList');
            
            if (!products || products.length === 0) {
                productsList.innerHTML = '<div class="no-data">No products found</div>';
                return;
            }
            
            productsList.innerHTML = '';
            
            products.forEach((product, index) => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-rank">${index + 1}</div>
                    <div class="product-info">
                        <div class="product-name">${product.name || 'Unknown Product'}</div>
                        <div class="product-sales">${(product.quantity || 0).toLocaleString()} kg sold</div>
                    </div>
                    <div class="product-revenue">‚Ç±${(product.sales || 0).toLocaleString()}</div>
                    <div class="product-trend positive">+${(product.growth || 0).toFixed(1)}%</div>
                `;
                productsList.appendChild(productItem);
            });
        }
    </script>
</body>
</html>