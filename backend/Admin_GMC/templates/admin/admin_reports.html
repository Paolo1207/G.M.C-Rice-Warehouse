<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GMC Admin</title>
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/Sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/Dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/Reports.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Sidebar directly embedded -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-top">
      <div class="sidebar-brand">
     <img src="{{ url_for('admin.static', filename='image/logo_of_gmc.png') }}" alt="GMC Logo" class="sidebar-logo-img">

      </div>
      <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke="#2e7d32" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    <nav class="sidebar-menu" id="sidebarMenu">
      <div class="sidebar-section">
        <div class="sidebar-section-title">Main</div>
        <ul>
          <li title="Dashboard">
  <a href="{{ url_for('admin.admin_dashboard') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="13" width="7" height="8" rx="2"/>
        <rect x="14" y="3" width="7" height="18" rx="2"/>
      </svg>
    </span>
    <span class="sidebar-label">Dashboard</span>
  </a>
</li>
           <li title="Analytics">
  <a href="{{ url_for('admin.analytics') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
      </svg>
    </span>
    <span class="sidebar-label">Analytics</span>
  </a>
</li>
           <li title="Forecast">
  <a href="{{ url_for('admin.forecast') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M3 17l6-6 4 4 8-8"/><path d="M14 7h7v7"/>
      </svg>
    </span>
    <span class="sidebar-label">Forecast</span>
  </a>
</li>

          <li title="Regional Insights">
  <a href="{{ url_for('admin.regional') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10A15.3 15.3 0 0 1 12 2z"/>
      </svg>
    </span>
    <span class="sidebar-label">Regional Insights</span>
  </a>
</li>
        </ul>
      </div>
      <div class="sidebar-section-divider"></div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">Operations</div>
        <ul>
          <li title="Inventory">
  <a href="{{ url_for('admin.inventory') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="7" width="18" height="13" rx="2"/><path d="M16 3v4"/><path d="M8 3v4"/>
      </svg>
    </span>
    <span class="sidebar-label">Inventory</span>
  </a>
</li>
          <li title="Sales">
  <a href="{{ url_for('admin.sales') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M3 17l6-6 4 4 8-8"/>
      </svg>
    </span>
    <span class="sidebar-label">Sales</span>
  </a>
</li>

         
        </ul>
      </div>
      <div class="sidebar-section-divider"></div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">Management</div>
        <ul>
          <li class="active"  title="Reports">
  <a href="{{ url_for('admin.reports') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
      </svg>
    </span>
    <span class="sidebar-label">Reports</span>
  </a>
</li>

           <li title="User Management">
  <a href="{{ url_for('admin.user') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="7" r="4"/><path d="M5.5 21a8.38 8.38 0 0 1 13 0"/>
      </svg>
    </span>
    <span class="sidebar-label">User Management</span>
  </a>
</li>
           <li title="Notifications">
  <a href="{{ url_for('admin.notifications') }}">
    <span class="sidebar-icon">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
    </span>
    <span class="sidebar-label">Notifications</span>
  </a>
</li>
        </ul>
      </div>
    </nav>
    <div class="sidebar-profile" style="display: flex; align-items: center; justify-content: center; height: 25px;">
      <div class="sidebar-profile-info" style="text-align: center; width: 100%; display: flex; align-items: center; justify-content: center;">
        <div class="sidebar-profile-name sidebar-label" style="margin: 0 auto;">Admin</div>
      </div>
    </div>
    <div class="sidebar-bottom">
      <ul>
        <li title="Settings" style="display: flex; align-items: center; justify-content: center; height: 25px;">
          <a href="{{ url_for('admin.settings') }}" style="text-align: center; width: 100%; display: flex; align-items: center; justify-content: center;">
            <span class="sidebar-label" style="margin: 0 auto;">Settings</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>
      </div>
    </aside>
    <script>
      // Sidebar collapse/expand logic
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      toggleBtn.onclick = () => {
        sidebar.classList.toggle('collapsed');
        document.body.classList.toggle('sidebar-collapsed', sidebar.classList.contains('collapsed'));
      };
    </script>
    <!-- End Sidebar -->
    <div class="main-content reports-module">
        <div class="reports-header">
            <h2>ðŸ“‘ Reports Module</h2>
            <div class="report-category-tabs">
                <button class="active" data-tab="forecast">Forecast</button>
                <button data-tab="inventory">Inventory</button>
                <button data-tab="sales">Sales</button>
            </div>
            <div class="reports-filters">
                <label>Date Range:
                    <select id="dateRangeSelect">
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90" selected>Last 90 Days</option>
                    </select>
                </label>
                <label>Product/Variant:
                    <select id="productSelect">
                        <option value="">All</option>
                    </select>
                </label>
                <label>Branch/Region:
                    <select id="branchSelect">
                        <option value="">All</option>
                    </select>
                </label>
            </div>
        </div>
        <div class="report-display-section">
            <div class="report-display-header">
                <h3 id="reportTitle">ðŸ“Š Sales Report</h3>
                <div class="export-buttons">
                    <button onclick="exportCurrent('csv')">Export CSV</button>
                    <button onclick="exportCurrent('xlsx')">Export Excel</button>
                    <button onclick="exportCurrent('pdf')">Export PDF</button>
                </div>
            </div>
            <table class="report-table">
                <thead>
                    <tr id="tableHeader"></tr>
                </thead>
                <tbody id="salesRows"></tbody>
                <tfoot>
                    <tr id="tableTotals"></tr>
                </tfoot>
            </table>
        </div>
        <div class="export-history-section">
            <h3>ðŸ•’ Export History Log</h3>
            <table class="export-history-table">
                <thead>
                    <tr>
                        <th>Report Name</th>
                        <th>User</th>
                        <th>Date/Time</th>
                        <th>File Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Demand Forecast Report</td><td>John Doe</td><td>2024-06-01 10:00</td><td>PDF</td><td><span class="status-tag completed">Completed</span></td></tr>
                    <tr><td>Inventory Summary</td><td>Jane Smith</td><td>2024-06-01 09:30</td><td>Excel</td><td><span class="status-tag completed">Completed</span></td></tr>
                    <tr><td>Sales Report</td><td>John Doe</td><td>2024-05-31 17:45</td><td>CSV</td><td><span class="status-tag failed">Failed</span></td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>
      // Sidebar collapse/expand logic (already present)
      // ... existing code ...
      // Tabs + filters wiring
      let currentTab = 'sales';
      document.addEventListener('DOMContentLoaded', () => {
        initTabs();
        loadFilters();
        renderCurrent();
      });

      function initTabs() {
        document.querySelectorAll('.report-category-tabs button').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.report-category-tabs button').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            currentTab = btn.dataset.tab;
            renderCurrent();
          });
        });
        document.getElementById('dateRangeSelect').addEventListener('change', renderCurrent);
        document.getElementById('productSelect').addEventListener('change', renderCurrent);
        document.getElementById('branchSelect').addEventListener('change', async () => {
          await loadProductsForBranch();
          // Reset product selection when branch changes
          document.getElementById('productSelect').value = '';
          await renderCurrent();
        });
      }

      async function loadFilters() {
        try {
          const branchesRes = await fetch('/admin/api/branches');
          const branches = await branchesRes.json();
          const branchSel = document.getElementById('branchSelect');
          const prodSel = document.getElementById('productSelect');
          
          if (branches.ok) {
            branches.branches.forEach(b => {
              const opt = document.createElement('option');
              opt.value = b.id; opt.textContent = b.name; branchSel.appendChild(opt);
            });
          }
          
          // Load products based on current branch filter
          await loadProductsForBranch();
        } catch(e) { console.error('loadFilters', e); }
      }

      async function loadProductsForBranch() {
        try {
          const branchId = document.getElementById('branchSelect').value;
          let url = '/admin/api/products';
          if (branchId) {
            url = `/admin/api/products?branch_id=${branchId}`;
          }
          const rp = await fetch(url).then(r=>r.json());
          const names = (rp.products||[]).map(p=>({id:p.id,name:p.name}));
          const prodSel = document.getElementById('productSelect');
          prodSel.innerHTML = '<option value="">All</option>' + names.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        }catch{}
      }

      function getDateRange() {
        const days = parseInt(document.getElementById('dateRangeSelect').value || '7', 10);
        const to = new Date();
        const from = new Date(); from.setDate(to.getDate() - days);
        const fmt = d => d.toISOString().slice(0,10);
        return { from: fmt(from), to: fmt(to) };
      }

      async function loadSales(page = 1) {
        try {
          const { from, to } = getDateRange();
          const branch_id = document.getElementById('branchSelect').value;
          const product_id = document.getElementById('productSelect').value;
          const params = new URLSearchParams({ page: String(page), page_size: '50', granularity: 'day', from, to });
          if (branch_id) params.set('branch_id', branch_id);
          if (product_id) params.set('product_id', product_id);
          const res = await fetch(`/admin/api/reports/sales?${params.toString()}`);
          const data = await res.json();
          console.log('Sales report data:', data);
          if (!data.ok) return;
          const header = document.getElementById('tableHeader');
          header.innerHTML = `<th>Date/Period</th><th>Branch</th><th>Product</th><th>Qty (kg)</th><th>Amount (â‚±)</th>`;
          const tbody = document.getElementById('salesRows');
          tbody.innerHTML = '';
          data.rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.date || r.d || ''}</td>
              <td>${r.branch_name || ''}</td>
              <td>${r.product_name || ''}</td>
              <td>${Number(r.qty_kg || r.qty || 0).toLocaleString()}</td>
              <td>â‚±${Number(r.amount || r.amt || 0).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
          });
          document.getElementById('reportTitle').textContent = 'ðŸ“Š Sales Report';
          document.getElementById('tableTotals').innerHTML = `
            <td colspan="3">Totals</td>
            <td>${Number(data.totals.sum_qty_kg||0).toLocaleString()}</td>
            <td>â‚±${Number(data.totals.sum_amount||0).toLocaleString()}</td>`;
        } catch (e) { console.error('loadSales failed', e); }
      }

      async function loadForecast(page = 1) {
        try {
          const { from, to } = getDateRange();
          const branch_id = document.getElementById('branchSelect').value;
          const product_id = document.getElementById('productSelect').value;
          const params = new URLSearchParams({ page: String(page), page_size: '50', from, to });
          if (branch_id) params.set('branch_id', branch_id);
          if (product_id) params.set('product_id', product_id);
          const res = await fetch(`/admin/api/reports/forecast?${params.toString()}`);
          const data = await res.json(); if (!data.ok) return;
          const header = document.getElementById('tableHeader');
          header.innerHTML = `<th>Date</th><th>Branch</th><th>Product</th><th>Forecast (kg)</th><th>Actual (kg)</th><th>Diff (kg)</th><th>MAPE %</th>`;
          const tbody = document.getElementById('salesRows'); tbody.innerHTML = '';
          data.rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.date || r.d || ''}</td>
              <td>${r.branch_name || ''}</td>
              <td>${r.product_name || ''}</td>
              <td>${Number(r.forecast_kg||0).toLocaleString()}</td>
              <td>${Number(r.actual_kg||0).toLocaleString()}</td>
              <td>${Number(r.diff_kg||0).toLocaleString()}</td>
              <td>${r.abs_pct_err == null ? '-' : Number(r.abs_pct_err).toFixed(2)+'%'}</td>
            `;
            tbody.appendChild(tr);
          });
          document.getElementById('reportTitle').textContent = 'ðŸ“Š Forecast vs Actual';
          const mape = data.totals.mape == null ? '-' : Number(data.totals.mape).toFixed(2)+'%';
          document.getElementById('tableTotals').innerHTML = `
            <td colspan="3">Totals</td>
            <td>${Number(data.totals.sum_forecast_kg||0).toLocaleString()}</td>
            <td>${Number(data.totals.sum_actual_kg||0).toLocaleString()}</td>
            <td></td>
            <td>${mape}</td>`;
        } catch(e) { console.error('loadForecast failed', e); }
      }

      async function loadInventory(page = 1) {
        try {
          const { from, to } = getDateRange();
          const branch_id = document.getElementById('branchSelect').value;
          const product_id = document.getElementById('productSelect').value;
          const params = new URLSearchParams({ page: String(page), page_size: '50', from, to });
          if (branch_id) params.set('branch_id', branch_id);
          if (product_id) params.set('product_id', product_id);
          const res = await fetch(`/admin/api/reports/inventory?${params.toString()}`);
          const data = await res.json(); if (!data.ok) return;
          const header = document.getElementById('tableHeader');
          header.innerHTML = `<th>Date</th><th>Branch</th><th>Product</th><th>Opening (kg)</th><th>In (kg)</th><th>Out (kg)</th><th>Closing (kg)</th>`;
          const tbody = document.getElementById('salesRows'); tbody.innerHTML='';
          data.rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.date || r.d || ''}</td>
              <td>${r.branch_name || ''}</td>
              <td>${r.product_name || ''}</td>
              <td>${r.opening_kg == null ? '-' : Number(r.opening_kg).toLocaleString()}</td>
              <td>${Number(r.received_kg||0).toLocaleString()}</td>
              <td>${Number(r.sold_kg||0).toLocaleString()}</td>
              <td>${Number(r.closing_kg||0).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
          });
          document.getElementById('reportTitle').textContent = 'ðŸ“Š Inventory Report';
          document.getElementById('tableTotals').innerHTML = `
            <td colspan="6">Avg Closing</td>
            <td>${Number(data.totals.avg_closing_kg||0).toLocaleString()}</td>`;
        } catch(e) { console.error('loadInventory failed', e); }
      }

      function renderCurrent() {
        if (currentTab === 'sales') return loadSales();
        if (currentTab === 'forecast') return loadForecast();
        if (currentTab === 'inventory') return loadInventory();
      }

      function exportCurrent(format) {
        const { from, to } = getDateRange();
        const branch_id = document.getElementById('branchSelect').value;
        const product_id = document.getElementById('productSelect').value;
        const params = new URLSearchParams({ format, from, to });
        if (branch_id) params.set('branch_id', branch_id);
        if (product_id) params.set('product_id', product_id);
        const type = currentTab === 'sales' ? 'sales' : (currentTab === 'forecast' ? 'forecast' : 'inventory');
        window.location.href = `/admin/api/reports/export/${type}?${params.toString()}`;
      }
    </script>
</body>
</html>